"use strict";angular.module("tantalim.desktop",["tantalim.common","ngRoute","ui.bootstrap","ngSanitize"]),angular.module("tantalim.desktop").factory("keyboardManager",["$window","$timeout",function(a,b){var c={},d={type:"keydown",propagate:!1,inputDisabled:!1,target:a.document,keyCode:!1};return c.keyboardEvent={},c.bind=function(e,f,g){var h,i,j,k;g=angular.extend({},d,g),e=e.toLowerCase(),i=g.target,"string"==typeof g.target&&(i=document.getElementById(g.target)),h=function(c){if(c=c||a.event,g.inputDisabled){var d;if(c.target?d=c.target:c.srcElement&&(d=c.srcElement),3===d.nodeType&&(d=d.parentNode),"INPUT"===d.tagName||"TEXTAREA"===d.tagName)return}c.keyCode?j=c.keyCode:c.which&&(j=c.which);var h=String.fromCharCode(j).toLowerCase();188===j&&(h=","),190===j&&(h=".");for(var i=e.split("+"),l=0,m={"`":"~",1:"!",2:"@",3:"#",4:"$",5:"%",6:"^",7:"&",8:"*",9:"(",0:")","-":"_","=":"+",";":":","'":'"',",":"<",".":">","/":"?","\\":"|"},n={esc:27,escape:27,tab:9,space:32,"return":13,enter:13,backspace:8,scrolllock:145,scroll_lock:145,scroll:145,capslock:20,caps_lock:20,caps:20,numlock:144,num_lock:144,num:144,pause:19,"break":19,insert:45,home:36,"delete":46,end:35,pageup:33,page_up:33,pu:33,pagedown:34,page_down:34,pd:34,left:37,up:38,right:39,down:40,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123},o={shift:{wanted:!1,pressed:!!c.shiftKey},ctrl:{wanted:!1,pressed:!!c.ctrlKey},alt:{wanted:!1,pressed:!!c.altKey},meta:{wanted:!1,pressed:!!c.metaKey}},p=0,q=i.length;k=i[p],q>p;p++){switch(k){case"ctrl":case"control":l++,o.ctrl.wanted=!0;break;case"shift":case"alt":case"meta":l++,o[k].wanted=!0}k.length>1?n[k]===j&&l++:g.keyCode?g.keyCode===j&&l++:h===k?l++:m[h]&&c.shiftKey&&(h=m[h],h===k&&l++)}return l!==i.length||o.ctrl.pressed!==o.ctrl.wanted||o.shift.pressed!==o.shift.wanted||o.alt.pressed!==o.alt.wanted||o.meta.pressed!==o.meta.wanted||(b(function(){f(c)},1),g.propagate)?void 0:(c.cancelBubble=!0,c.returnValue=!1,c.stopPropagation&&(c.stopPropagation(),c.preventDefault()),!1)},c.keyboardEvent[e]={callback:h,target:i,event:g.type},i.addEventListener?i.addEventListener(g.type,h,!1):i.attachEvent?i.attachEvent("on"+g.type,h):i["on"+g.type]=h},c.unbind=function(a){a=a.toLowerCase();var b=c.keyboardEvent[a];if(delete c.keyboardEvent[a],b){var d=b.event,e=b.target,f=b.callback;e.detachEvent?e.detachEvent("on"+d,f):e.removeEventListener?e.removeEventListener(d,f,!1):e["on"+d]=!1}},c}]),angular.module("tantalim.desktop").config(function(a,b){a.html5Mode(!0).hashPrefix("!"),b.debugEnabled(!0)}),angular.module("tantalim.desktop").controller("PageController",function(a,b,c,d,e,f,g,h,i,j,k){function l(){a.$watch("SmartPage.filterValues",function(c){b(c,a.SmartPage.filterComparators)},!0),a.$watch("SmartPage.filterComparators",function(c){b(a.SmartPage.filterValues,c)},!0);var b=function(b,c){var d="";angular.forEach(b,function(a,b){a&&(d.length>0&&(d+=" AND "),d+=b+" "+c[b]+' "'+a+'"')}),a.SmartPage.filterString=d};b(a.SmartPage.filterValues,a.SmartPage.filterComparators)}a.buttons=i.buttons,a.$http=j;var m=null,n={LEFT:1,RIGHT:3},o=function(){var a={start:0,end:0,getStart:function(){return a.start<a.end?a.start:a.end},getEnd:function(){return a.start<a.end?a.end:a.start},between:function(b){return a.getStart()<=b&&b<=a.getEnd()},length:function(){return a.getEnd()-a.getStart()}};return a},p=function(a){var i="/search",j={current:null,topSection:null,sections:{},getSection:function(a){return j.sections[a]?j.sections[a]:void b.info("self.sections[sectionName] has not been created yet")},showLoadingScreen:!0,loadingFailed:!1,loadData:function(){function a(a){return k.info(""),200!==a.status?(k.error("Failed to reach server. Try refreshing."),void(j.loadingFailed=!0)):a.data.error?(k.error("Error reading data from server: "+a.data.error.message),void(j.loadingFailed=!0)):(j.maxPages=a.data.maxPages,f.setRoot(b,a.data.rows),j.turnSearchOff(),j.topSection.fixSelectedRows(),void(j.showLoadingScreen=!1))}k.info("Loading data..."),k.error("");var b=j.topSection.model;b.customUrlSource?e.readUrl(b.customUrlSource).then(a):e.readModelData(b.name,j.filter(),j.page()).then(a)},refresh:function(){return b.debug("refresh()"),f.dirty()&&!k.getStatus()?void k.info("There are unsaved changes. Click [Refresh] again to discard those changes."):void j.loadData()},save:function(){k.info("Saving..."),h.save(j.topSection.model,f.root,function(a){k.info(""),k.error(a)})},focus:function(a){j.current&&j.current.unbindHotKeys(),j.current=a,a.bindHotKeys()},bindHotKeys:function(){g.bind("ctrl+s",function(){j.save()}),g.bind("meta+s",function(){j.save()}),g.bind("ctrl+shift+d",function(){j.toConsole()})},toConsole:function(){console.log("SmartPage.current",j.current),console.log("SmartPage.sections",j.sections),f.toConsole()},initialize:function(a){b.debug("SmartPage.initialize()",a),_.forEach(a.sections,function(a){new q(a,j.sections)}),j.topSection=j.sections[d.page.sections[0].name],j.showSearch=c.path()===i,angular.forEach(j.topSection.fields,function(a){switch(a.fieldType){case"checkbox":j.filterValues[a.name]=null,j.filterComparators[a.name]="Equals";break;default:j.filterComparators[a.name]="Contains"}}),j.filter(),j.focus(j.topSection)},showSearch:void 0,filterString:"",filterValues:{},filterComparators:{},turnSearchOn:function(){c.path(i),j.showSearch=!0},turnSearchOff:function(){c.path("/"),j.showSearch=!1},runSearch:function(){b.debug("runSearch()"),j.filterString?j.filter(j.filterString):c.search({}),j.loadData()},filter:function(a){return a&&(console.info("Updating filter",a),c.search("filter",a)),c.search().filter},maxPages:99,page:function(a){return a&&(console.info("Updating page",a),c.search("page",a)),parseInt(c.search().page||1)},showPagingOnSection:function(a){return j.maxPages>1?j.topSection.name===a:!1},previousPage:function(){var a=j.page();a>1&&j.page(a-1)},nextPage:function(){var a=j.page();a<j.maxPages&&j.page(a+1)}};return j.initialize(a),j},q=function(c,d){b.debug("Creating SmartSection ",c);var e={FORM:"form",TABLE:"table"},h={name:c.name,viewMode:c.viewMode,model:c.model,fields:c.fields,orderBy:{},orderByField:function(a){h.orderBy={field:a,direction:a===h.orderBy.field?!h.orderBy.direction:!1},h.getCurrentSet().sort(h.orderBy.field,h.orderBy.direction)},toggleViewMode:function(){h.viewMode===e.FORM?h.viewMode=e.TABLE:(h.selectedRows.end=h.selectedRows.start,h.stopEditing(),h.viewMode=e.FORM),h.unbindHotKeys(),h.bindHotKeys()},copy:function(){var b=h.getCurrentSet().rows.slice(h.selectedRows.getStart(),h.selectedRows.getEnd()+1);a.clipboard=[],angular.forEach(b,function(b){var c=[];angular.forEach(h.fields,function(a,d){h.selectedColumns.between(d)&&c.push(b.data[a.name])}),a.clipboard.push(c)});var c=a.clipboard.map(function(a){return a.join("	")}).join("\n"),d=$("#clipboard");d.val(c),d.select()},paste:function(){if(a.clipboard.length>0){var b=h.getCurrentSet().rows.slice(h.selectedRows.getStart(),h.selectedRows.getEnd()+1),c=0,d=a.clipboard.length,e=a.clipboard[0].length;angular.forEach(b,function(b){var f=a.clipboard[c],g=0;angular.forEach(h.fields,function(a,c){h.selectedColumns.between(c)&&(b.update(a.name,f[g]),g++,e===g&&(g=0))}),c++,d===c&&(c=0)})}},getCurrentSet:function(){return f.getCurrentSet(h.model.name)},unbindHotKeys:function(){h.bound=!1;var a="meta",b=["up","down","right","left","shift+tab","shift+down",a+"+c",a+"+v",a+"+t",a+"+d",a+"+i"];angular.forEach(b,function(a){g.unbind(a)})},bindHotKeys:function(){if(!h.bound){h.bound=!0;var a="meta";h.viewMode===e.TABLE&&(g.bind("up",function(){h.moveToPreviousRow()}),g.bind("down",function(){h.moveToNextRow()}),g.bind("right",function(){h.moveNextColumn()}),g.bind("tab",function(){h.moveNextColumn()}),g.bind("left",function(){h.movePreviousColumn()}),g.bind("shift+tab",function(){h.movePreviousColumn()}),g.bind("shift+up",function(){h.selectUp()}),g.bind("shift+down",function(){h.selectDown()}),g.bind(a+"+c",function(){h.copy()},{propagate:!0}),g.bind(a+"+v",function(){h.paste()},{propagate:!0})),g.bind("ctrl+t",function(){h.toggleViewMode()}),g.bind(a+"+d",function(){h["delete"]()}),g.bind(a+"+i",function(){h.insert()})}},selectedRows:new o,selectedColumns:new o,hover:{},cellIsSelected:function(a,b){return h.selectedRows.between(a)&&h.selectedColumns.between(b)},moveToPreviousRow:function(){h.selectedRows.start--,h.selectedRows.end=h.selectedRows.start,h.selectedColumns.end=h.selectedColumns.start,h.fixSelectedRows()},moveToNextRow:function(){h.selectedRows.start++,h.selectedRows.end=h.selectedRows.start,h.selectedColumns.end=h.selectedColumns.start,h.fixSelectedRows()},mousedown:function(a,b){if(event.which===n.LEFT){if(h.cellIsEditing(a,b))return;m=null,h.selectedRows.selecting=!0,h.selectedRows.start=h.selectedRows.end=a,h.selectedColumns.start=h.selectedColumns.end=b,h.mouseover(a,b)}},mouseover:function(a,b){h.hover={row:a,column:b},h.cellIsEditing(a,b)||h.selectedRows.selecting&&(h.selectedRows.end=a,h.selectedColumns.end=b,event.preventDefault(),event.stopPropagation())},isHoveredOverCell:function(a,b){return h.hover.row===a&&h.hover.column===b},mouseup:function(){event.which===n.LEFT&&(h.selectedRows.selecting=!1,h.fixSelectedRows())},dblclick:function(a,b){event.which===n.LEFT&&h.startEditing(a,b)},startEditing:function(a,b){a=a||h.selectedRows.start,b=b||h.selectedColumns.start;var c=h.fields[b],d=h.getCurrentSet().getInstance(a);return d.isFieldEditable(c.name)?(m=h.name,g.bind("esc",function(){h.stopEditing()}),g.bind("enter",function(){}),void h.unbindHotKeys()):void console.warn(c.name+" is not editable")},stopEditing:function(){m=null,g.unbind("esc"),g.bind("enter",function(){h.startEditing()}),h.bindHotKeys()},getSelectedRows:function(){return _.slice(h.getCurrentSet().rows,h.selectedRows.start,h.selectedRows.end+1)},insert:function(){h.getCurrentSet().insert(),h.selectedRows.start=h.selectedRows.end=h.getCurrentSet().index,h.fixSelectedRows()},"delete":function(){for(var a=h.selectedRows.start;a<=h.selectedRows.end;a++)h.getCurrentSet()["delete"](h.selectedRows.start);h.selectedRows.end=h.selectedRows.start,h.fixSelectedRows()},selectUp:function(){h.selectedRows.end--},selectDown:function(){h.selectedRows.end++},moveNextColumn:function(){h.selectedColumns.start>=h.fields.length-1||(h.selectedColumns||(h.selectedColumns.start=-1),h.selectedColumns.start++,h.selectedColumns.end=h.selectedColumns.start,h.selectedRows.end=h.selectedRows.start)},movePreviousColumn:function(){0!==h.selectedColumns.start&&(h.selectedColumns.start--,h.selectedColumns.end=h.selectedColumns.start,h.selectedRows.end=h.selectedRows.start)},cellIsEditing:function(a,b){return m===h.name&&h.selectedRows.start===a&&h.selectedColumns.start===b},focus:function(a,b){return h.cellIsEditing(a,b)?!0:!1},fixSelectedRows:function(){function a(a,b,c){return void 0===a?b:b>a?b:a>c?c:a}if(0===h.getCurrentSet().rows.length)h.selectedRows.start=h.selectedRows.end=-1;else{var b=h.getCurrentSet().rows.length-1;h.selectedRows.start=a(h.selectedRows.start,0,b),h.selectedRows.end=a(h.selectedRows.end,0,b)}h.getCurrentSet().index=h.selectedRows.start,f.resetCurrents(h.getCurrentSet())}};d||(d={}),d[h.name]&&console.warn("Duplicate section named "+h.name),d[h.name]=h,_.forEach(c.sections,function(a){new q(a,d)})};a.clipboard=[],a.clipboardToExcel="",a.link=function(a,b,c){var d=r.getSection(c).getCurrentSet().getInstance();_.forEach(d.data,function(a,c){b=b.replace("["+c+"]",d.data[c]),b=b.replace("${"+c+"}",d.data[c])}),i.location.href="/page/"+a+"/?filter="+b};var r=new p(d.page);r.bindHotKeys(),a.SmartPage=r,l(),a.Logger=k,a.$on("$locationChangeSuccess",function(){b.debug("$locationChangeSuccess()"),r.showSearch?r.showLoadingScreen=!1:r.loadData()})}),angular.module("tantalim.desktop").directive("tntCheckbox",function(){return{restrict:"E",controllerAs:"$checkbox",controller:function(a,b){function c(a){d.value=a?a.data[e]:null}var d=this;d.value=null,d.label=b.label,d.help=b.help;var e=b.targetField,f="true"===b.required;d.toggle=function(){a.currentInstance.toggle(e,f),c(a.currentInstance)},a.$watch("currentInstance",c)},scope:{currentInstance:"="},transclude:!0,template:'<div class="checkbox"><span ng-transclude></span><label class="control-label no-select" class="ui-checkbox" for="{{$checkbox.id}}" data-ng-click="$checkbox.toggle()"><i data-ng-show="$checkbox.value === true" class="fa fa-lg fa-fw fa-check-square-o"></i><i data-ng-show="$checkbox.value === false" class="fa fa-lg fa-fw fa-square-o"></i><i data-ng-show="$checkbox.value === null || $checkbox.value === undefined" class="fa fa-lg fa-fw fa-square-o disabled"></i> {{$checkbox.label}} </label><span data-ng-show="$checkbox.help" class="help-block"><i class="fa fa-info-circle"></i> {{$checkbox.help}}</span></div>'}}),angular.module("tantalim.desktop").directive("focusMe",function(a){return{scope:{trigger:"=focusMe"},link:function(b,c){b.$watch("trigger",function(b){b===!0&&a(function(){c[0].focus(),c[0].select()})})}}}),angular.module("tantalim.desktop").directive("tntHelp",function(){return{restrict:"E",transclude:!0,link:function(a,b,c){a.title=c.label?"Help for "+c.label:""},template:'<div class="tnt-links"><button class="btn btn-default btn-xs dropdown-toggle" type="button" data-toggle="dropdown" aria-expanded="true"><i class="fa fa-question"></i></button><div role="menu" aria-labelledby="dropdownMenu1" class="panel panel-default dropdown-menu dropdown-menu-right"><div class="panel-heading" data-ng-show="title"><h3 class="panel-title">{{title}} <span class="pull-right"><i class="fa fa-question"></i></span></h3></div><div class="panel-body" ng-transclude></div></div></div>'}}),angular.module("tantalim.desktop").directive("tntLinks",function(){return{restrict:"E",transclude:!0,template:'<div class="dropdown tnt-links"><button class="btn btn-default btn-xs dropdown-toggle" type="button" data-toggle="dropdown" aria-expanded="true"><span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span></button><ul class="dropdown-menu dropdown-menu-right" role="menu" aria-labelledby="dropdownMenu1" ng-transclude></ul></div>'}}).directive("tntLink",function(a){return{restrict:"E",compile:function(){return function(b,c,d){var e='<li role="presentation"><a role="menuitem" tabindex="-1" href="#" data-ng-click="link(\''+d.target+"', '"+(d.filter.replace(/'/g,"\\'").replace(/"/g,"\\'")||"")+"', '"+(d.section||"")+"')\">"+d.label+"</a></li>",f=a(e)(b);c.replaceWith(f)}}}}),angular.module("tantalim.desktop").directive("tntSection",function(){return{restrict:"E",controllerAs:"$section",controller:function(a,b){var c=this;c.id=b.id,c.title=b.title,c.current=b.current},transclude:!0,template:'<div id="{{$section.id}}" class="tntSection childSection"><h2>{{$section.title}}</h2><div data-ng-hide="hide{{$section.id}} || {{$section.current}}.getCurrentSet().rows.length"><div ng-transclude></div></div>'}}).directive("tntForm",function(){return{restrict:"E",controllerAs:"$form",controller:function(a,b){var c=this;c.id=b.id},transclude:!0,template:'<div id="$section.id" class="tntSection childSection"><div ng-transclude></div></div>'}}),angular.module("tantalim.desktop").directive("tntSelect",function(){return{restrict:"E",controllerAs:"$select",controller:function(a,b,c,d,e,f,g){var h="",i=this;i.empty=!1,i.open=!1,i.activeIndex=void 0,i.items=void 0,i.label=c.label;var j=c.sourceField;i.sourceField=c.sourceField;var k,l=c.targetId,m=c.targetField;c.otherMappings&&(console.info("Eval "+c.otherMappings),k=a.$eval(c.otherMappings));var n="";i.id=m;var o=function(){i.open=!0,i.activeIndex=void 0;var b=a.currentInstance;if(b)for(var c=0;c<i.items.length;c++){var d=i.items[c];l?d.id===b.data[l]&&(i.activeIndex=c):d.data[j]===b.data[m]&&(i.activeIndex=c)}};i.activate=function(){var b=c.sourceItems;if(b)return void 0===i.items&&(i.items=a.$eval(b)),void o();var d=c.sourceFilter;if(d){var e=/\${(\w+)}/gi;d=d.replace(e,function(b,c){var d=a.currentInstance.getValue(c);if(void 0===d)throw new Error("You must select "+c+" first");return d})}void 0===i.items||n!==d?(i.loading=!0,i.filter=h,console.info("readModelData where",d),g.readModelData(c.sourceModel,d).then(function(b){return i.loading=!1,200!==b.status?(a.serverError="Failed to reach server. Try refreshing.",console.error("Failed to reach server. Try refreshing."),void console.error(b)):b.data.error?(a.serverError="Error reading data from server: "+b.data.error,void console.error("Error reading data from server:",b.data.error)):(i.items=b.data.rows,n=d,void o())})):o(),f("select-search-"+i.id)},i.choose=function(b){var c=a.currentInstance;c.update(m,b.data[j]),i.display=c.data[m],l&&(c.data[l]=b.id),k&&(console.info("updating otherMappings ",k),_.forEach(k,function(a){c.update(a.target,b.data[a.source])})),i.open=!1,i.empty=!1,f("select-button-"+i.id)};var p={Enter:13,Tab:9,Up:38,Down:40,Escape:27};i.keydown=function(a){switch(a){case p.Down:i.activeIndex<i.items.length-1?i.activeIndex++:i.activeIndex=0;break;case p.Up:i.activeIndex>0?i.activeIndex--:i.activeIndex=i.items.length-1;break;case p.Tab:case p.Enter:i.choose(i.items[i.activeIndex]);break;case p.Escape:i.open=!1,f("select-button-"+i.id);break;default:return!1}return!0};var q=function(){if(i.open&&i.items.length>0&&void 0!==i.activeIndex){var a=d[0].querySelectorAll(".ui-select-choices-content")[0],b=a.querySelectorAll(".ui-select-choices-row");if(0===b.length)return void(a.scrollTop=0);var c=b[i.activeIndex],e=c.offsetTop+c.clientHeight-a.scrollTop,f=a.offsetHeight;e>f?a.scrollTop+=e-f:e<c.clientHeight&&(a.scrollTop-=c.clientHeight-e)}};a.$watch("$select.activeIndex",function(){q()}),a.$watch("currentInstance",function(a){_.isEmpty(a)?(i.display="",i.empty=!0):(i.display=a.data[m],i.empty=!1)})},scope:{currentInstance:"="},transclude:!0,template:'<label class="control-label" for="@(page.model.name)-@field.name">{{$select.label}}</label><span ng-transclude></span><div class="ui-select-bootstrap dropdown" ng-class="{open: $select.open}"><button type="button" class="btn btn-default dropdown-toggle form-control ui-select-match" focus-on="select-button-{{$select.id}}" data-ng-hide="$select.open" data-ng-click="$select.activate()"><span ng-hide="$select.empty">{{$select.display}}</span><span ng-show="$select.empty" class="text-muted">Select...</span><i class="loading fa fa-spinner fa-spin" data-ng-show="$select.loading"></i><span class="caret"></span></button><button class="btn btn-xs btn-default ui-select-close" data-ng-show="$select.open" data-ng-click="$select.open = false"><i class="fa fa-times"></i></button><input class="form-control" data-ng-show="$select.open" focus-on="select-search-{{$select.id}}" data-ng-model="$select.filter" select-keydown><ul class="ui-select-choices ui-select-choices-content dropdown-menu" role="menu" ng-show="$select.items.length> 0"><li class="ui-select-choices-row" data-ng-repeat="item in $select.items" ng-class="{active: $select.activeIndex===$index}" ng-mouseenter="$select.activeIndex = $index"><a href="" data-ng-click="$select.choose(item)">{{item.data[$select.sourceField]}}</a></li></ul></div>'}}).directive("selectKeydown",function(){return function(a,b){b.bind("keydown keypress",function(b){a.$apply(function(){var c=a.$select.keydown(b.which,a.current);c&&b.preventDefault()})})}}).directive("focusOn",function(){return function(a,b,c){a.$on("focusOn",function(a,d){d===c.focusOn&&b[0].focus()})}}).factory("focus",function(a,b){return function(c){b(function(){a.$broadcast("focusOn",c)})}}),angular.module("tantalim.desktop").directive("tntTextbox",function(){return{restrict:"E",controllerAs:"$textbox",controller:function(a,b){var c=this;c.value=null,c.label=b.label,c.placeholder=b.placeholder;var d=b.name;c.id=d,c.name=d,c.change=function(){console.info("update"+d),a.currentInstance.update(d)},c.disabled=function(){if("true"===b.disabled)return!0;var c="false"===b.updateable;return"INSERTED"!==a.state&&c},c.required=function(){return"true"===b.required?!0:!1},c.blur=function(){b.blurFunction&&console.info("blur not implemented yet")}},scope:{currentInstance:"="},transclude:!0,template:'<span ng-transclude></span><label class="control-label" for="{{$textbox.id}}">{{$textbox.label}}</label><input type="text" class="form-control" id="{{$textbox.id}}" name="{{$textbox.name}}"data-ng-model="currentInstance.data[$textbox.name]" ng-focus=""ng-change="$textbox.change()"ng-blur="$textbox.blur()"ng-disabled="$textbox.disabled()"ng-required="$textbox.required()"placeholder="{{$textbox.placeholder}}" select-on-click>'}}).directive("selectOnClick",function(){return{restrict:"A",link:function(a,b){b.on("click",function(){this.select()})}}}),angular.module("tantalim.common",[]),angular.module("tantalim.common").factory("Global",[function(){return{pageName:window.pageName,modelName:window.pageName,user:window.user,authenticated:!!window.user}}]),angular.module("tantalim.common").factory("GUID",function(){function a(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return function(){return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()}}),angular.module("tantalim.common").factory("Logger",[function(){function a(a){return"string"==typeof a?{message:a}:a}var b={TYPE:{INFO:"info",WARN:"warn",ERROR:"warn",DEBUG:"debug"},history:[],log:function(c,d){c=a(c),c.type=d||b.TYPE.INFO,c.type===b.TYPE.ERROR?b._error=c.message:b._status=c.message,b.history.push(c)},info:function(a){b.log(a)},warn:function(a){b.log(a,b.TYPE.WARN)},debug:function(a){b.log(a,b.TYPE.DEBUG)},error:function(a){b.log(a,b.TYPE.ERROR)},getStatus:function(){return b._status},getError:function(){return b._error}};return b}]),angular.module("tantalim.common").factory("ModelCursor",["$filter","$log","GUID",function($filter,$log,GUID){var rootSet,current,modelMap,clear=function(){rootSet=null,current={},modelMap={}};clear();var fillModelMap=function(a,b){modelMap[a.name]=a,a.parent=b,_.forEach(a.children,function(b){fillModelMap(b,a.name)})},STATE={NO_CHANGE:"NO_CHANGE",DELETED:"DELETED",INSERTED:"INSERTED",UPDATED:"UPDATED",CHILD_UPDATED:"CHILD_UPDATED"},SmartNodeInstance=function(model,row,nodeSet){function setFieldDefault(field,row){if(field.fieldDefault){$log.debug("Defaulting field ",field);var DEFAULT_TYPE={CONSTANT:"Constant",FIELD:"Field",FXN:"Fxn"};switch(field.fieldDefault.type){case DEFAULT_TYPE.FIELD:row.data[field.name]=row.getValue(field.fieldDefault.value);break;case DEFAULT_TYPE.FXN:row.data[field.name]=eval(field.fieldDefault.value);break;case DEFAULT_TYPE.CONSTANT:var value=field.fieldDefault.value;switch(field.dataType){case"Boolean":value="true"===value}row.data[field.name]=value;break;default:console.error("Failed to match fieldDefault.type on ",field)}$log.debug("defaulted "+field.name+" to "+row.data[field.name]+" of type "+typeof row.data[field.name])}}$log.debug("Adding SmartNodeInstance id:%s for model `%s` onto set ",row.id,model.name,nodeSet);var defaults={_type:"SmartNodeInstance",id:null,data:{},nodeSet:null,childModels:{},state:STATE.NO_CHANGE,"delete":function(){this.state=STATE.DELETED},isDirty:function(){return this.state!==STATE.NO_CHANGE},toggle:function(a,b){var c=this.data[a],d=!0;c===!0&&(d=!1),void 0===c&&(d=!0),c===!1&&(d=b?!0:null),console.info("Setting ",a,d),this.update(a,d)},getValue:function(a){if(console.info("finding value for fieldName: ",a,this.data),this.data.hasOwnProperty(a))return this.data[a];if(this.nodeSet.parentInstance)return this.nodeSet.parentInstance.getValue(a);throw new Error("Cannot find field called "+a)},update:function(a,b,c){console.info("update "+a+" to "+b),c=c||!1;var d=modelMap[nodeSet.model.modelName].fields[a];d||console.error("Failed to find field named "+a+" in ",modelMap[nodeSet.model.modelName].fields),(d.updateable||c)&&(a&&("TableName"===a&&b&&(this.data.TableSQL="app_"+this.data[a].toLowerCase()),void 0!==b&&(this.data[a]=b)),(this.state===STATE.NO_CHANGE||this.state===STATE.CHILD_UPDATED)&&(this.state=STATE.UPDATED,this.updateParent()))},updateParent:function(){if(this.nodeSet){var a=this.nodeSet.parentInstance;a&&a.state===STATE.NO_CHANGE&&(a.state=STATE.CHILD_UPDATED,a.updateParent())}},isFieldEditable:function(){return!0}},newInstance=_.defaults(row,defaults);return newInstance.nodeSet=nodeSet,null===row.id&&(newInstance.state=STATE.INSERTED,newInstance.id=GUID(),_.forEach(model.fields,function(a){setFieldDefault(a,row)})),newInstance.addChildModel=function(a,b){$log.debug("addChildModel ",a,b);var c=new SmartNodeSet(modelMap[a],b,newInstance,nodeSet.depth+1);newInstance.childModels[a]=c},_.forEach(model.children,function(a){row.children?newInstance.addChildModel(a.name,row.children[a.name]):newInstance.addChildModel(a.name,[])}),newInstance},SmartNodeSet=function(a,b,c,d){var e={_type:"SmartNodeSet",model:{modelName:null,parentInstance:null,orderBy:null,childModels:[]},parent:{instance:null,model:null},rows:[],deleted:[],depth:d||0,index:-1,sort:function(a,b){this.rows=$filter("orderBy")(this.rows,"data."+a,b)},sortReverse:function(){this.sort(!0)},moveTo:function(a){0>a||a>=this.rows.length||(this.index=a,self.resetCurrents(this))},movePrevious:function(){this.moveTo(this.index-1)},moveNext:function(){this.moveTo(this.index+1)},hasPrevious:function(){return this.index>0},hasNext:function(){return this.index+1<this.rows.length},findIndex:function(a){return _.findIndex(this.rows,function(b){return b.id===a})},isDirty:function(){if(this.deleted&&this.deleted.length>0)return!0;var a=_.find(this.rows,function(a){return a.isDirty()});return!_.isEmpty(a)},"delete":function(a){console.info("deleting on set with index =",a);var b=this.rows[a];b.state!==STATE.INSERTED&&(this.deleted.push(b),b.updateParent()),this.rows.splice(a,1)},deleteEnabled:function(){return null!==this.getInstance()},getInstance:function(a){return this.rows&&0!==this.rows.length?(this.index<0&&(this.index=0),a=a||this.index||0,this.rows[a]):(this.index=-1,null)},reloadFromServer:function(a){$log.debug("reloadFromServer with returned data",a),$log.debug("this set",this),_.forEach(this.rows,function(b){var c;switch(b.state){case STATE.INSERTED:c=_.find(a,function(a){return a.tempID===b.id}),$log.debug("matching inserted row",b,c),c?(b.state=STATE.NO_CHANGE,b.data=c.data,b.id=c.id):console.error("Failed to find matching inserted row",b);break;case STATE.UPDATED:case STATE.CHILD_UPDATED:c=_.find(a,function(a){return a.id===b.id}),$log.debug("matching update or child_updated row",b,c),c?(b.state=STATE.NO_CHANGE,b.state===STATE.UPDATED&&(b.data=c.data)):console.error("Failed to find matching updated row",b)}b.childModels&&c&&c.children&&(console.info(b.childModels),console.info(c),_.forEach(b.childModels,function(a,d){console.info(d);var e=c.children[d];e&&b.childModels[d].reloadFromServer(e)}))}),this.deleted=[]}},f=_.defaults({},e);return f.model.modelName=a.name,f.model.orderBy=a.orderBy,f.parentInstance=c,f.insert=function(){$log.debug("Inserting new instance with model");var b=new SmartNodeInstance(a,{},f);return f.rows.push(b),f.index=f.rows.length-1,b.updateParent(),self.resetCurrents(f),b},angular.isArray(b)&&(_.forEach(b,function(b){var c=new SmartNodeInstance(a,b,f);f.rows.push(c)}),self.resetCurrents(f)),f},self={root:rootSet,current:current,setRoot:function(a,b){return $log.debug("Setting Root data"),$log.debug(a),$log.debug(b),clear(),self.current=current,_.isEmpty(a)?void console.warn("setRoot called with empty model, exiting"):(fillModelMap(a),rootSet=new SmartNodeSet(a,b),self.root=rootSet,void self.resetCurrents(rootSet))},getCurrentSet:function(a){return _.isEmpty(self.current)||self.current[a]||(console.warn("getCurrentSet is empty",a),console.warn("current = ",self.current)),self.current[a]},resetCurrents:function(a){if(!a||"SmartNodeSet"!==a._type)throw new Error("resetCurrents() requires a SmartNodeSet but got",a);var b=a.model.modelName,c=modelMap[b];self.clearCurrentChildren(c),self.current[b]=a;var d=a.getInstance();c&&c.children&&_.forEach(c.children,function(a){if(d&&d.childModels){var b=d.childModels[a.name];b&&self.resetCurrents(b)}})},clearCurrentChildren:function(a){a.children&&_.forEach(a.children,function(a){current[a.name]=null,self.clearCurrentChildren(a)})},dirty:function(){return rootSet?rootSet.isDirty():!1},toConsole:function(){console.log("ModelCursor.rootSet",self.root),console.log("ModelCursor.modelMap",modelMap),console.log("ModelCursor.current",self.current)}};return self}]),angular.module("tantalim.common").factory("ModelSaver",["$http","$log",function(a,b){var c,d={convertToDto:function(a,c){var e=(a.name,function(a){return{state:a.state,tempID:a.id,data:a.data}}),f=function(a){return{state:a.state,id:a.id,data:a.data}},g=function(a){return{state:"DELETED",id:a.id}},h=function(a,b,c){var e=!1;a.children={},_.forEach(b.children,function(b){var f=b.name,g=d.convertToDto(b,c.childModels[f]);g.length>0&&(a.children[f]=g,e=!0)}),e||delete a.children},i=[];return c?(b.debug(c),_.forEach(c.rows,function(b){var c={};c="INSERTED"===b.state?e(b):"UPDATED"===b.state?f(b):"CHILD_UPDATED"===b.state?f(b):null,c&&(i.push(c),h(c,a,b))}),_.forEach(c.deleted,function(b){var c=g(b);i.push(c),h(c,a,b)}),i):(b.debug("dataSet is empty so exit"),i)},sendData:function(d,e,f){b.debug("sendData()..."),b.debug(e),a.post("/data/"+d,e).success(function(a,d){b.debug("Returned success"),b.debug(d),200===d?a.error?f("Failed to save data "+a.error.message):(c.reloadFromServer(a),f("")):(f("Failed "+d),console.error(d),console.error(a))}).error(function(a,b){f(404===b?"Server not found. Check your Internet connection and try again.":"Server returned an unknown "+b+" error")})},save:function(a,e,f){c=e,b.debug("Starting ModelSaver.save");var g=d.convertToDto(a,c);d.sendData(a.name,g,f)}};return d}]),angular.module("tantalim.common").factory("PageService",function(a){var b={readModelData:function(a,c,d){var e="/data/"+a+"?";return c&&(e+="filter="+c),d&&(c&&(e+="&"),e+="page="+d),b.readUrl(e)},readUrl:function(b){return a.get(b)}};return b});