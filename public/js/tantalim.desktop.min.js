"use strict";angular.module("tantalim.desktop",["tantalim.common","ngRoute","ui.bootstrap","ngSanitize","tantalim.select"]),angular.module("tantalim.desktop").factory("keyboardManager",["$window","$timeout",function(a,b){var c={},d={type:"keydown",propagate:!1,inputDisabled:!1,target:a.document,keyCode:!1};return c.keyboardEvent={},c.bind=function(e,f,g){var h,i,j,k;g=angular.extend({},d,g),e=e.toLowerCase(),i=g.target,"string"==typeof g.target&&(i=document.getElementById(g.target)),h=function(c){if(c=c||a.event,g.inputDisabled){var d;if(c.target?d=c.target:c.srcElement&&(d=c.srcElement),3===d.nodeType&&(d=d.parentNode),"INPUT"===d.tagName||"TEXTAREA"===d.tagName)return}c.keyCode?j=c.keyCode:c.which&&(j=c.which);var h=String.fromCharCode(j).toLowerCase();188===j&&(h=","),190===j&&(h=".");for(var i=e.split("+"),l=0,m={"`":"~",1:"!",2:"@",3:"#",4:"$",5:"%",6:"^",7:"&",8:"*",9:"(",0:")","-":"_","=":"+",";":":","'":'"',",":"<",".":">","/":"?","\\":"|"},n={esc:27,escape:27,tab:9,space:32,"return":13,enter:13,backspace:8,scrolllock:145,scroll_lock:145,scroll:145,capslock:20,caps_lock:20,caps:20,numlock:144,num_lock:144,num:144,pause:19,"break":19,insert:45,home:36,"delete":46,end:35,pageup:33,page_up:33,pu:33,pagedown:34,page_down:34,pd:34,left:37,up:38,right:39,down:40,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123},o={shift:{wanted:!1,pressed:c.shiftKey?!0:!1},ctrl:{wanted:!1,pressed:c.ctrlKey?!0:!1},alt:{wanted:!1,pressed:c.altKey?!0:!1},meta:{wanted:!1,pressed:c.metaKey?!0:!1}},p=0,q=i.length;k=i[p],q>p;p++){switch(k){case"ctrl":case"control":l++,o.ctrl.wanted=!0;break;case"shift":case"alt":case"meta":l++,o[k].wanted=!0}k.length>1?n[k]===j&&l++:g.keyCode?g.keyCode===j&&l++:h===k?l++:m[h]&&c.shiftKey&&(h=m[h],h===k&&l++)}return l!==i.length||o.ctrl.pressed!==o.ctrl.wanted||o.shift.pressed!==o.shift.wanted||o.alt.pressed!==o.alt.wanted||o.meta.pressed!==o.meta.wanted||(b(function(){f(c)},1),g.propagate)?void 0:(c.cancelBubble=!0,c.returnValue=!1,c.stopPropagation&&(c.stopPropagation(),c.preventDefault()),!1)},c.keyboardEvent[e]={callback:h,target:i,event:g.type},i.addEventListener?i.addEventListener(g.type,h,!1):i.attachEvent?i.attachEvent("on"+g.type,h):i["on"+g.type]=h},c.unbind=function(a){a=a.toLowerCase();var b=c.keyboardEvent[a];if(delete c.keyboardEvent[a],b){var d=b.event,e=b.target,f=b.callback;e.detachEvent?e.detachEvent("on"+d,f):e.removeEventListener?e.removeEventListener(d,f,!1):e["on"+d]=!1}},c}]),angular.module("tantalim.desktop").config(function(a){a.html5Mode(!0).hashPrefix("!")}),angular.module("tantalim.desktop").controller("PageController",function(a,b,c,d,e,f,g,h){function i(){var a="/search",c={showSearch:void 0,initialize:function(){c.showSearch=b.path()===a},turnSearchOn:function(){b.path(a),c.showSearch=!0},turnSearchOff:function(){b.path("/"),c.showSearch=!1},filter:function(a){return a&&b.search("f",a),b.search().f},page:function(a){return a&&b.search("p",a),b.search().p}};return c}function j(){a.serverStatus="Loading data...",a.serverError="",d.readModelData(c.page.model.name,l.filter(),l.page()).then(function(b){return a.serverStatus="",200!==b.status?void(a.serverError="Failed to reach server. Try refreshing."):b.data.error?void(a.serverError="Error reading data from server: "+b.data.error):(a.filterString=l.filter(),a.pageNumber=l.page(),e.setRoot(c.page.model,b.data),a.ModelCursor=e,a.current=e.current,a.action=e.action,l.turnSearchOff(),void(a.showLoadingScreen=!1))})}function k(){l.initialize(),l.showSearch?a.showLoadingScreen=!1:j()}if(a.showLoadingScreen=!0,c.error)return console.error("Error retrieving PageDefinition: ",c.error),a.serverStatus="",a.serverError=c.error,void(c.message&&(a.serverError+=": "+c.message));if(!c.page.model)return void(a.serverError=c.page.name+" page does not have a model defined.");var l=new i;a.searchController=l,g.initialize(c.page),a.PageCursor=g,a.chooseModel=function(b){a.currentModel=b},a.chooseModel(c.page.model.name),function(){h.bind("up",function(){a.currentModel&&a.action.previous(a.currentModel)}),h.bind("down",function(){a.currentModel&&a.action.next(a.currentModel)}),h.bind("ctrl+d",function(){a.currentModel&&a.action["delete"](a.currentModel)}),h.bind("ctrl+n",function(){a.currentModel&&a.action.insert(a.currentModel)}),h.bind("shift+up",function(){var a=l.page()||1;a>1&&l.page(a-1)}),h.bind("shift+down",function(){var a=l.page()||1,b=999;b>a&&l.page(a+1)}),h.bind("ctrl+s",function(){a.save()}),h.bind("ctrl+shift+d",function(){console.log("DEBUGGING"),e.toConsole(),g.toConsole()})}(),function(){a.rowChanged=function(a){e.change(a)},a.refresh=function(){return e.dirty&&!a.serverStatus?void(a.serverStatus="There are unsaved changes. Click [Refresh] again to discard those changes."):void j()},a.save=function(){a.serverStatus="Saving...",f.save(c.page.model,e.root,function(b){a.serverStatus="",a.serverError=b,b||(e.dirty=!1)})}}(),function(){a.filterValues={},a.filterComparators={},_.forEach(c.page.model.fields,function(b){a.filterComparators[b.name]="Contains"}),a.runSearch=function(){a.filterString?l.filter(a.filterString):b.search({}),j()},a.$watch("filterValues",function(b){d(b,a.filterComparators)},!0),a.$watch("filterComparators",function(b){d(a.filterValues,b)},!0);var d=function(b,c){var d="";_.forEach(a.filterValues,function(a,b){a&&(d.length>0&&(d+=" AND "),d+=b+" "+c[b]+" "+a)}),a.filterString=d};a.filterString=""}(),a.$on("$locationChangeSuccess",function(){k()}),k()}),angular.module("tantalim.desktop").factory("PageCursor",function(a){var b={current:null,sections:{},toConsole:function(){console.log("PageCursor.current",b.current),console.log("PageCursor.sections",b.sections)}},c=function(d){var e={name:d.name,viewMode:d.viewMode||"single"};b.sections[d.name]=e,_.forEach(d.children,function(a){new c(a)}),_.forEach(d.page,function(b){a.warn("Using child pages is deprecated",e,b),new c(b)})};return b.initialize=function(b){a.debug("initializing PageCursor"),new c(b)},b}),angular.module("tantalim.common",[]),angular.module("tantalim.common").factory("Global",[function(){return{pageName:window.pageName,modelName:window.pageName,user:window.user,authenticated:!!window.user}}]),angular.module("tantalim.common").factory("GUID",function(){function a(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return function(){return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()}}),angular.module("tantalim.common").factory("Logger",[function(){var a=[],b={Message:function(){return this},log:function(b){a.push(b)}};return b}]),angular.module("tantalim.common").factory("ModelCursor",["$filter","$log","GUID",function($filter,$log,GUID){function markParentOfThisInstanceChanged(a){var b=a.nodeSet.parentInstance;b&&"NO_CHANGE"===b.state&&(b.state="CHILD_UPDATED",markParentOfThisInstanceChanged(b))}var rootSet,current,modelMap,clear=function(){rootSet=null,current={sets:{},instances:{}},modelMap={}};clear();var fillModelMap=function(a,b){var c=a.name;c?(modelMap[c]=a,a.parent=b,_.forEach(a.children,function(a){fillModelMap(a,c)})):console.warn("failed to fill modelMap for %s",a)},resetCurrents=function(a,b){!b&&a&&(b=a.model.modelName);var c=modelMap[b];current.sets[b]=a;var d=null;if(a&&(d=a.getInstance()),current.instances[b]=d,c&&c.children){var e=function(a){return d&&d.childModels?d.childModels[a]:null};_.forEach(c.children,function(a){var b=a.name,c=e(b);resetCurrents(c,b)})}},SmartNodeInstance=function(model,row,nodeSet){function getFieldValue(a,b){return b.nodeSet.parentInstance?b.nodeSet.parentInstance.data[a]?b.nodeSet.parentInstance.data[a]:getFieldValue(a,b.nodeSet.parentInstance):($log.error("Cannot find field called "+a),null)}function setFieldDefault(field,row){if(field.fieldDefault){var DEFAULT_TYPE={CONSTANT:"constant",FIELD:"field",FXN:"fxn"};switch(field.fieldDefault.type){case DEFAULT_TYPE.FIELD:row.data[field.name]=getFieldValue(field.fieldDefault.value,row);break;case DEFAULT_TYPE.FXN:row.data[field.name]=eval(field.fieldDefault.value);break;case DEFAULT_TYPE.CONSTANT:default:row.data[field.name]=field.fieldDefault.value}$log.debug("defaulted "+field.name+" to "+row.data[field.name])}}var defaults={_type:"SmartNodeInstance",id:null,data:{},nodeSet:null,childModels:{},state:"NO_CHANGE","delete":function(){this.state="DELETED"},update:function(){"NO_CHANGE"===this.state&&(this.state="UPDATED")}},newInstance=_.defaults(row,defaults);return newInstance.nodeSet=nodeSet,null===row.id?(newInstance.state="INSERTED",newInstance.id=GUID(),_.forEach(model.fields,function(a){setFieldDefault(a,row)}),newInstance):(newInstance.addChildModel=function(a,b){var c=a.name,d=new SmartNodeSet(a,b,newInstance);newInstance.childModels[c]=d},row.children&&_.forEach(model.children,function(a){var b=a.name;newInstance.addChildModel(a,row.children[b])}),newInstance)},SmartNodeSet=function(a,b,c){var d={_type:"SmartNodeSet",model:{modelName:null,parentInstance:null,orderBy:null,childModels:[]},parent:{instance:null,model:null},currentIndex:-1,rows:[],deleted:[],sort:function(a){var b=this.model.orderBy;angular.isString(b)&&(b="data."+b),this.rows=$filter("orderBy")(this.rows,b,a)},sortReverse:function(){this.sort(!0)},moveTo:function(a){0>a||a>=this.rows.length||(this.currentIndex=a,resetCurrents(this))},moveNext:function(){this.moveTo(this.currentIndex+1)},movePrevious:function(){this.moveTo(this.currentIndex-1)},moveToTop:function(){this.moveTo(0)},moveToBottom:function(){this.moveTo(this.rows.length-1)},findIndex:function(a){return _.findIndex(this.rows,function(b){return b.id==a})},"delete":function(a){if(!(this.rows.length<=0)){var b=this.getInstance(a).id,c=_.remove(this.rows,function(a){return a.id===b});c=_.remove(c,function(a){return"INSERTED"!==a.state}),c&&c.length>0&&(markParentOfThisInstanceChanged(c[0]),this.deleted.push(c[0])),this.currentIndex>=this.rows.length&&(this.currentIndex=this.rows.length-1),resetCurrents(this)}},getInstance:function(a){return a||(a=this.currentIndex),(!a||0>a)&&(a=0),this.rows&&0!==this.rows.length?this.rows[a]:null},reloadFromServer:function(a){$log.debug("reloadFromServer"),$log.debug(a),$log.debug(this),_.forEach(this.rows,function(b){var c;switch(b.state){case"INSERTED":$log.debug(b),c=_.find(a,function(a){return a.tempID===b.id}),c?(b.state="NO_CHANGE",b.data=c.data,b.id=c.id):console.error("Failed to find matching inserted row",b);break;case"UPDATED":$log.debug(b),c=_.find(a,function(a){return a.id===b.id}),c?(b.state="NO_CHANGE",b.data=c.data):console.error("Failed to find matching updated row",b)}}),this.deleted.length=0}},e=_.defaults({},d);return e.model.modelName=a.name,e.model.orderBy=a.orderBy,e.parentInstance=c,e.insert=function(){var b=new SmartNodeInstance(a,{},e);return e.rows.push(b),e.moveToBottom(),markParentOfThisInstanceChanged(b),b},angular.isArray(b)?(_.forEach(b,function(b){var c=new SmartNodeInstance(a,b,e);e.rows.push(c)}),e.rows.length&&(e.currentIndex=0)):(console.warn("SmartNodeSet expected data to be array but got the following:"),console.warn(b)),e},self={root:rootSet,current:current,setRoot:function(a,b){return clear(),_.isEmpty(a)?void console.warn("setRoot called with empty model, exiting"):(fillModelMap(a),rootSet=new SmartNodeSet(a,b),self.root=rootSet,resetCurrents(rootSet),self.current=current,void(self.dirty=!1))},getCurrentInstance:function(a){return current.instances[a]},getCurrentSet:function(a){if(void 0===current.sets[a]){var b=modelMap[a].parent,c=current.instances[b];c.addChildModel({data:{modelName:a}},[]),resetCurrents(self.root)}return current.sets[a]},dirty:!1,toConsole:function(){console.log("ModelCursor.rootSet",self.root),console.log("ModelCursor.modelMap",modelMap),console.log("ModelCursor.current",self.current)},change:function(a){console.info("changing",a),("NO_CHANGE"===a.state||"CHILD_UPDATED"===a.state)&&(self.dirty=!0,a.state="UPDATED",markParentOfThisInstanceChanged(a))},action:{length:function(a){return _.isEmpty(current.sets[a])?0:current.sets[a].rows.length},insert:function(a){var b=self.getCurrentSet(a).insert();return self.dirty=!0,b},"delete":function(a,b){current.sets[a]["delete"](b),self.dirty=!0},deleteEnabled:function(a){return null!=current.instances[a]},choose:function(a,b){var c=current.sets[a].findIndex(b);current.sets[a].moveTo(c)},select:function(a,b){current.sets[a].moveTo(b)},previous:function(a){current.sets[a].movePrevious()},next:function(a){current.sets[a].moveNext()}}};return self}]),angular.module("tantalim.common").factory("ModelSaver",["$http","$log",function(a,b){var c,d={convertToDto:function(a,c){var e=(a.name,function(a){return{state:a.state,tempID:a.id,data:a.data}}),f=function(a){return{state:a.state,id:a.id,data:a.data}},g=function(a){return{state:"DELETED",id:a.id}},h=function(a,b,c){var e=!1;a.children={},_.forEach(b.children,function(b){var f=b.name,g=d.convertToDto(b,c.childModels[f]);g.length>0&&(a.children[f]=g,e=!0)}),e||delete a.children},i=[];return c?(b.debug(c),_.forEach(c.rows,function(b){var c={};c="INSERTED"===b.state?e(b):"UPDATED"===b.state?f(b):"CHILD_UPDATED"===b.state?f(b):null,c&&(i.push(c),h(c,a,b))}),_.forEach(c.deleted,function(b){var c=g(b);i.push(c),h(c,a,b)}),i):(b.debug("dataSet is empty so exit"),i)},sendData:function(d,e,f){b.debug("sendData()..."),b.debug(e),a.post("/data/"+d,e).success(function(a,b){200===b?a.error?f("Failed to save data "+a.error):(c.reloadFromServer(a),f()):(f("Failed "+b),console.error(b),console.error(a))}).error(function(a,b){404===b&&f("Server not found. Check your Internet connection and try again."),console.error(b),console.error(a)})},save:function(a,e,f){c=e,b.debug("Starting ModelSaver.save");var g=d.convertToDto(a,c);d.sendData(a.name,g,f)}};return d}]),angular.module("tantalim.common").factory("PageService",function(a){return{readModelData:function(b,c,d){var e="/data/"+b+"?";return c&&(e+="filterString="+c),d&&(c&&(e+="&"),e+="pageNumber="+d),a.get(e)}}});