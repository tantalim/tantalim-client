"use strict";angular.module("tantalim.desktop",["tantalim.common","ngRoute","ui.bootstrap","ngSanitize","tantalim.select"]),angular.module("tantalim.desktop").directive("focusMe",function(a){return{scope:{trigger:"=focusMe"},link:function(b,c){b.$watch("trigger",function(b){b===!0&&a(function(){c[0].focus(),c[0].select()})})}}}),angular.module("tantalim.desktop").factory("keyboardManager",["$window","$timeout",function(a,b){var c={},d={type:"keydown",propagate:!1,inputDisabled:!1,target:a.document,keyCode:!1};return c.keyboardEvent={},c.bind=function(e,f,g){var h,i,j,k;g=angular.extend({},d,g),e=e.toLowerCase(),i=g.target,"string"==typeof g.target&&(i=document.getElementById(g.target)),h=function(c){if(c=c||a.event,g.inputDisabled){var d;if(c.target?d=c.target:c.srcElement&&(d=c.srcElement),3===d.nodeType&&(d=d.parentNode),"INPUT"===d.tagName||"TEXTAREA"===d.tagName)return}c.keyCode?j=c.keyCode:c.which&&(j=c.which);var h=String.fromCharCode(j).toLowerCase();188===j&&(h=","),190===j&&(h=".");for(var i=e.split("+"),l=0,m={"`":"~",1:"!",2:"@",3:"#",4:"$",5:"%",6:"^",7:"&",8:"*",9:"(",0:")","-":"_","=":"+",";":":","'":'"',",":"<",".":">","/":"?","\\":"|"},n={esc:27,escape:27,tab:9,space:32,"return":13,enter:13,backspace:8,scrolllock:145,scroll_lock:145,scroll:145,capslock:20,caps_lock:20,caps:20,numlock:144,num_lock:144,num:144,pause:19,"break":19,insert:45,home:36,"delete":46,end:35,pageup:33,page_up:33,pu:33,pagedown:34,page_down:34,pd:34,left:37,up:38,right:39,down:40,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123},o={shift:{wanted:!1,pressed:!!c.shiftKey},ctrl:{wanted:!1,pressed:!!c.ctrlKey},alt:{wanted:!1,pressed:!!c.altKey},meta:{wanted:!1,pressed:!!c.metaKey}},p=0,q=i.length;k=i[p],q>p;p++){switch(k){case"ctrl":case"control":l++,o.ctrl.wanted=!0;break;case"shift":case"alt":case"meta":l++,o[k].wanted=!0}k.length>1?n[k]===j&&l++:g.keyCode?g.keyCode===j&&l++:h===k?l++:m[h]&&c.shiftKey&&(h=m[h],h===k&&l++)}return l!==i.length||o.ctrl.pressed!==o.ctrl.wanted||o.shift.pressed!==o.shift.wanted||o.alt.pressed!==o.alt.wanted||o.meta.pressed!==o.meta.wanted||(b(function(){f(c)},1),g.propagate)?void 0:(c.cancelBubble=!0,c.returnValue=!1,c.stopPropagation&&(c.stopPropagation(),c.preventDefault()),!1)},c.keyboardEvent[e]={callback:h,target:i,event:g.type},i.addEventListener?i.addEventListener(g.type,h,!1):i.attachEvent?i.attachEvent("on"+g.type,h):i["on"+g.type]=h},c.unbind=function(a){a=a.toLowerCase();var b=c.keyboardEvent[a];if(delete c.keyboardEvent[a],b){var d=b.event,e=b.target,f=b.callback;e.detachEvent?e.detachEvent("on"+d,f):e.removeEventListener?e.removeEventListener(d,f,!1):e["on"+d]=!1}},c}]),angular.module("tantalim.desktop").config(function(a,b){a.html5Mode(!0).hashPrefix("!"),b.debugEnabled(!0)}),angular.module("tantalim.desktop").controller("PageController",function(a,b,c,d,e,f,g,h,i,j){var k=function(a){var i="/search",k={current:null,topSection:null,sections:[],getSection:function(a,c){return k.sections[c]&&k.sections[c][a]?k.sections[c][a]:void b.info("self.sections[level][sectionName] has not been created yet")},showLoadingScreen:!0,loadingFailed:!1,loadData:function(){j.info("Loading data..."),j.error("");var a=k.topSection.model;e.readModelData(a.name,k.filter(),k.page()).then(function(b){return j.info(""),200!==b.status?(j.error("Failed to reach server. Try refreshing."),void(k.loadingFailed=!0)):b.data.error?(j.error("Error reading data from server: "+b.data.error.message),void(k.loadingFailed=!0)):(k.maxPages=b.data.maxPages,f.setRoot(a,b.data.rows),k.initialize(d.page,b.data.rows),k.turnSearchOff(),void(k.showLoadingScreen=!1))})},refresh:function(){return b.debug("refresh()"),f.dirty()&&!j.getStatus()?void j.info("There are unsaved changes. Click [Refresh] again to discard those changes."):void k.loadData()},save:function(){j.info("Saving..."),h.save(k.topSection.model,f.root,function(a){j.info(""),j.error(a)})},focus:function(a){console.info("focus ",a),k.current&&k.current.unbindHotKeys(),k.current=a,a.bindHotKeys()},bind:function(){g.bind("ctrl+s",function(){k.save()}),g.bind("meta+s",function(){k.save()}),g.bind("ctrl+shift+d",function(){k.toConsole()})},toConsole:function(){console.log("SmartPage.current",k.current),console.log("SmartPage.sections",k.sections),f.toConsole()},initialize:function(a){b.debug("SmartPage.initialize()",a),_.forEach(a.sections,function(a){new l(a,0,k.sections)}),console.info(k.sections),k.topSection=k.sections[0][d.page.sections[0].name],k.showSearch=c.path()===i,angular.forEach(k.topSection.fields,function(a){k.filterComparators[a.name]="Contains"}),k.filter(),k.focus(k.topSection)},showSearch:void 0,filterValues:{},filterComparators:{},turnSearchOn:function(){c.path(i),k.showSearch=!0},turnSearchOff:function(){c.path("/"),k.showSearch=!1},filter:function(a){return a&&c.search("filter",a),c.search().filter},maxPages:99,page:function(a){return a&&c.search("page",a),parseInt(c.search().page||1)},previousPage:function(){var a=k.page();a>1&&k.page(a-1)},nextPage:function(){var a=k.page();a<k.maxPages&&k.page(a+1)}};return k.initialize(a),k},l=function(a,c,d){b.debug("Creating SmartSection ",a);var e={FORM:"form",TABLE:"table"},h={name:a.name,viewMode:a.viewMode,model:a.model,fields:a.fields,toggleViewMode:function(){if(console.info("toggleViewMode",this),h.viewMode===e.FORM)h.viewMode=e.TABLE;else{var a=h.getCurrentSet();a.selectedRows.end=a.selectedRows.start,h.viewMode=e.FORM}},copy:function(){current.gridSelection&&(m=_.cloneDeep(current.gridSelection))},paste:function(){if(m&&current.gridSelection){var a=getRows(m),b=getRows(current.gridSelection),c=0;_.forEach(b,function(b){c>=a.length&&(c=0);var d=a[c];_.forEach(current.gridSelection.columns,function(a,c){b.update(c,d.data[c])}),c++})}},level:c||0,getCurrentSet:function(){return f.getCurrentSet(h.model.name,h.level)},unbindHotKeys:function(){_.forEach(g.keyboardEvent,function(a,b){g.unbind(b)})},bindHotKeys:function(){g.bind("up",function(){h.getCurrentSet().movePrevious()}),g.bind("tab",function(){h.getCurrentSet().moveNext()}),g.bind("enter",function(){h.getCurrentSet().moveNext()}),g.bind("down",function(){h.getCurrentSet().moveNext()}),g.bind("ctrl+d",function(){h.getCurrentSet()["delete"]()}),g.bind("ctrl+n",function(){h.getCurrentSet().insert()}),g.bind("meta+c",function(){h.copy()}),g.bind("meta+v",function(){h.paste()})}};d[h.level]||(d[h.level]={}),d[h.level][h.name]=h,_.forEach(a.sections,function(a){new l(a,h.level+1,d)})},m=null;!function(){a.$watch("filterValues",function(c){b(c,a.filterComparators)},!0),a.$watch("filterComparators",function(c){b(a.filterValues,c)},!0);var b=function(b,c){var d="";angular.forEach(a.filterValues,function(a,b){a&&(d.length>0&&(d+=" AND "),d+=b+" "+c[b]+' "'+a+'"')}),a.filterString=d};a.filterString=""}(),a.link=function(a,b,c){var d=f.getCurrentSet(c,0).getSelectedRows();_.forEach(d.data,function(a,c){b=b.replace("["+c+"]",d.data[c])}),i.location.href="/page/"+a+"/?filter="+b},a.$on("$locationChangeSuccess",function(){b.debug("$locationChangeSuccess()"),a.Logger=j;var c=new k(d.page);a.SmartPage=c,c.showSearch?c.showLoadingScreen=!1:c.loadData()})}),angular.module("tantalim.common",[]),angular.module("tantalim.common").factory("Global",[function(){return{pageName:window.pageName,modelName:window.pageName,user:window.user,authenticated:!!window.user}}]),angular.module("tantalim.common").factory("GUID",function(){function a(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return function(){return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()}}),angular.module("tantalim.common").factory("Logger",[function(){function a(a){return"string"==typeof a?{message:a}:a}var b={TYPE:{INFO:"info",WARN:"warn",ERROR:"warn",DEBUG:"debug"},history:[],log:function(c,d){c=a(c),c.type=d||b.TYPE.INFO,c.type===b.TYPE.ERROR?b._error=c.message:b._status=c.message,b.history.push(c)},info:function(a){b.log(a)},warn:function(a){b.log(a,b.TYPE.WARN)},debug:function(a){b.log(a,b.TYPE.DEBUG)},error:function(a){b.log(a,b.TYPE.ERROR)},getStatus:function(){return b._status},getError:function(){return b._error}};return b}]),angular.module("tantalim.common").factory("ModelCursor",["$filter","$log","GUID",function($filter,$log,GUID){function getRows(a,b){var c=a.rows.start,d=1+a.rows.end;b>d-c&&(d=c+b);var e=getCurrentSet(a.model,level).rows;return _.slice(e,c,d)}var rootSet,current,modelMap,clipboard,editCell,clear=function(){rootSet=null,current=[],modelMap={},clipboard={},editCell={}};clear();var MOUSE={LEFT:1,RIGHT:3},fillModelMap=function(a,b){modelMap[a.name]=a,a.parent=b,_.forEach(a.children,function(b){fillModelMap(b,a.name)})},getCurrentSet=function(a,b){b=b||0,current[b]||(current[b]={});var c=current[b];return void 0===c[a]&&modelMap[a]?void 0:c[a]},getOrAddCurrentSet=function(a,b){var c=getCurrentSet(a,b);if(c)return c;$log.warn("current set for %s hasn't been created yet, creating now.",a,current);var d=currentLevel.instances[parentName];d.addChildModel(a),resetCurrents(self.root)},resetCurrents=function(a){if(!a||"SmartNodeSet"!==a._type)throw new Error("resetCurrents() requires a SmartNodeSet but got",a);var b=a.model.modelName,c=a.depth;current[c]||(current[c]={});var d=modelMap[b];console.warn("Set current level ",c,b,d),current[c][b]=a;for(var e=c+1;e<current.length;e++)console.warn('deleting levels child "higher" than this '+c,current[e]),delete current[e];var f=a.getInstance();console.warn(" Using nextInstance ",f),d&&d.children&&_.forEach(d.children,function(a){if(f&&f.childModels){var b=f.childModels[a.name];b&&(console.info("adding child set ",a.name),resetCurrents(b))}}),console.warn("DONE Setting Current",current)},SmartNodeInstance=function(model,row,nodeSet){function setFieldDefault(field,row){if(field.fieldDefault){$log.debug("Defaulting field ",field);var DEFAULT_TYPE={CONSTANT:"Constant",FIELD:"Field",FXN:"Fxn"};switch(field.fieldDefault.type){case DEFAULT_TYPE.FIELD:row.data[field.name]=row.getValue(field.fieldDefault.value);break;case DEFAULT_TYPE.FXN:row.data[field.name]=eval(field.fieldDefault.value);break;case DEFAULT_TYPE.CONSTANT:var value=field.fieldDefault.value;switch(field.dataType){case"Boolean":value="true"===value}row.data[field.name]=value;break;default:console.error("Failed to match fieldDefault.type on ",field)}$log.debug("defaulted "+field.name+" to "+row.data[field.name]+" of type "+typeof row.data[field.name])}}var defaults={_type:"SmartNodeInstance",id:null,data:{},nodeSet:null,childModels:{},state:"NO_CHANGE","delete":function(){this.state="DELETED"},isDirty:function(){return"NO_CHANGE"!==this.state},toggle:function(a,b){var c=this.data[a],d=!0;c===!0&&(d=!1),void 0===c&&(d=!0),c===!1&&(d=b?!0:null),console.info("Setting ",a,d),this.update(a,d)},getValue:function(a){if(console.info("finding value for fieldName: ",a,this.data),this.data.hasOwnProperty(a))return this.data[a];if(this.nodeSet.parentInstance)return this.nodeSet.parentInstance.getValue(a);throw new Error("Cannot find field called "+a)},update:function(a,b){var c=modelMap[nodeSet.model.modelName].fields[a];c||console.error("Failed to find field named "+a+" in ",modelMap[nodeSet.model.modelName].fields),c.updateable&&(a&&("TableName"===a&&b&&(this.data.TableSQL="app_"+this.data[a].toLowerCase()),void 0!==b&&(this.data[a]=b)),("NO_CHANGE"===this.state||"CHILD_UPDATED"===this.state)&&(this.state="UPDATED",this.updateParent()))},updateParent:function(){if(this.nodeSet){console.info(this);var a=this.nodeSet.parentInstance;a&&"NO_CHANGE"===a.state&&(a.state="CHILD_UPDATED",a.updateParent())}}},newInstance=_.defaults(row,defaults);return newInstance.nodeSet=nodeSet,null===row.id&&($log.debug("id is null, so assume record is newly inserted",row),newInstance.state="INSERTED",newInstance.id=GUID(),_.forEach(model.fields,function(a){setFieldDefault(a,row)})),newInstance.addChildModel=function(a,b){var c=new SmartNodeSet(modelMap[a],b,newInstance,nodeSet.depth+1);newInstance.childModels[a]=c},row.children&&_.forEach(model.children,function(a){newInstance.addChildModel(a.name,row.children[a.name])}),$log.debug("Done creating newInstance"),newInstance},SmartNodeSet=function(a,b,c,d){var e={_type:"SmartNodeSet",model:{modelName:null,parentInstance:null,orderBy:null,childModels:[]},parent:{instance:null,model:null},selectedRows:{},selectedColumns:{},rows:[],deleted:[],depth:d||0,sort:function(a){var b=this.model.orderBy;angular.isString(b)&&(b="data."+b),this.rows=$filter("orderBy")(this.rows,b,a)},sortReverse:function(){this.sort(!0)},moveTo:function(a){0>a||a>=this.rows.length||(this.selectedRows.start=a,this.selectedRows.end=a,console.info("moveTo"),resetCurrents(this))},moveNext:function(){this.moveTo(this.selectedRows.start+1)},movePrevious:function(){this.moveTo(this.selectedRows.start-1)},moveToBottom:function(){this.moveTo(this.rows.length-1)},mousedown:function(a,b){if(event.which===MOUSE.LEFT){if(this.cellIsEditing(a,b))return;editCell={},this.selectedRows={selecting:!0,start:a,end:a},this.selectedColumns={},this.mouseover(a,b)}},mouseover:function(a,b){if(event.which===MOUSE.LEFT){if(this.cellIsEditing(a,b))return;this.selectedRows.selecting&&(this.selectedRows.end=a,this.selectedColumns[b]=!0,event.preventDefault(),event.stopPropagation())}},mouseup:function(){event.which===MOUSE.LEFT&&(this.selectedRows.selecting=!1,this.fixSelectedRows())},dblclick:function(a,b){if(event.which===MOUSE.LEFT){var c=modelMap[this.model.modelName].fields[b],d=this.getInstance(a);("INSERTED"===d.state||c.updateable)&&(editCell={model:this.model.modelName,level:this.depth,row:a,column:b})}},cellIsSelected:function(a,b){var c=this.selectedRows.start,d=this.selectedRows.end;return c>d&&(c=d,d=this.selectedRows.start),a>=c&&d>=a&&this.selectedColumns[b]},cellIsEditing:function(a,b){return editCell.model===this.model.modelName&&editCell.level===this.depth&&this.selectedRows.start===a&&editCell.column===b},focus:function(a,b){return this.cellIsEditing(a,b)?!0:!1},findIndex:function(a){return _.findIndex(this.rows,function(b){return b.id===a})},fixSelectedRows:function(){function a(a,b,c){return void 0===a?b:b>a?b:a>c?c:a}if(0===this.rows.length)this.selectedRows={start:-1,end:-1};else{var b=this.rows.length-1;if(this.selectedRows.start=a(this.selectedRows.start,0,b),this.selectedRows.end=a(this.selectedRows.end,0,b),this.selectedRows.end<this.selectedRows.start){var c=this.selectedRows.end;this.selectedRows.end=this.selectedRows.start,this.selectedRows.start=c}}console.info("fixSelectedRows"),resetCurrents(this)},isDirty:function(){if(this.deleted&&this.deleted.length>0)return!0;var a=_.find(this.rows,function(a){return a.isDirty()});return!_.isEmpty(a)},"delete":function(){if(!(this.rows.length<=0)){for(var a=this.selectedRows.start;a<=this.selectedRows.end;a++){var b=this.rows[a];"INSERTED"!==b.state&&(this.deleted.push(b),b.updateParent())}this.rows.splice(this.selectedRows.start,1+this.selectedRows.end-this.selectedRows.start),this.fixSelectedRows()}},deleteEnabled:function(){return null!==this.getInstance()},getInstance:function(a){return this.rows&&0!==this.rows.length?(a||(a=this.selectedRows.start),(!a||0>a)&&(a=0),this.rows[a]):null},getSelectedRows:function(){return _.slice(this.rows,this.selectedRows.start,this.selectedRows.end)},reloadFromServer:function(a){$log.debug("reloadFromServer"),$log.debug(a),$log.debug(this),_.forEach(this.rows,function(b){var c;switch(b.state){case"INSERTED":$log.debug(b),c=_.find(a,function(a){return a.tempID===b.id}),c?(b.state="NO_CHANGE",b.data=c.data,b.id=c.id):console.error("Failed to find matching inserted row",b);break;case"UPDATED":$log.debug(b),c=_.find(a,function(a){return a.id===b.id}),c?(b.state="NO_CHANGE",b.data=c.data):console.error("Failed to find matching updated row",b)}}),this.deleted.length=0}},f=_.defaults({},e);return f.model.modelName=a.name,f.model.orderBy=a.orderBy,f.parentInstance=c,f.insert=function(){$log.debug("Inserting new instance with model");var b=new SmartNodeInstance(a,{},f);return f.rows.push(b),f.moveToBottom(),b.updateParent(),b},angular.isArray(b)&&(_.forEach(b,function(b){var c=new SmartNodeInstance(a,b,f);f.rows.push(c)}),f.fixSelectedRows()),f},self={root:rootSet,current:current,setRoot:function(a,b){return $log.debug("Setting Root data"),$log.debug(a),$log.debug(b),clear(),_.isEmpty(a)?void console.warn("setRoot called with empty model, exiting"):(fillModelMap(a),rootSet=new SmartNodeSet(a,b),self.root=rootSet,console.info("setRoot"),resetCurrents(rootSet),void(self.current=current))},getCurrentSet:getCurrentSet,editCell:function(){return editCell},dirty:function(){return rootSet?rootSet.isDirty():!1},toConsole:function(){console.log("ModelCursor.rootSet",self.root),console.log("ModelCursor.modelMap",modelMap),console.log("ModelCursor.current",self.current)},action:{escape:function(){editCell={}}}};return self}]),angular.module("tantalim.common").factory("ModelSaver",["$http","$log",function(a,b){var c,d={convertToDto:function(a,c){var e=(a.name,function(a){return{state:a.state,tempID:a.id,data:a.data}}),f=function(a){return{state:a.state,id:a.id,data:a.data}},g=function(a){return{state:"DELETED",id:a.id}},h=function(a,b,c){var e=!1;a.children={},_.forEach(b.children,function(b){var f=b.name,g=d.convertToDto(b,c.childModels[f]);g.length>0&&(a.children[f]=g,e=!0)}),e||delete a.children},i=[];return c?(b.debug(c),_.forEach(c.rows,function(b){var c={};c="INSERTED"===b.state?e(b):"UPDATED"===b.state?f(b):"CHILD_UPDATED"===b.state?f(b):null,c&&(i.push(c),h(c,a,b))}),_.forEach(c.deleted,function(b){var c=g(b);i.push(c),h(c,a,b)}),i):(b.debug("dataSet is empty so exit"),i)},sendData:function(d,e,f){b.debug("sendData()..."),b.debug(e),a.post("/data/"+d,e).success(function(a,d){b.debug("Returned success"),b.debug(d),200===d?a.error?f("Failed to save data "+a.error.message):(c.reloadFromServer(a),f("")):(f("Failed "+d),console.error(d),console.error(a))}).error(function(a,b){f(404===b?"Server not found. Check your Internet connection and try again.":"Server returned an unknown "+b+" error")})},save:function(a,e,f){c=e,b.debug("Starting ModelSaver.save");var g=d.convertToDto(a,c);d.sendData(a.name,g,f)}};return d}]),angular.module("tantalim.common").factory("PageService",function(a){return{readModelData:function(b,c,d){var e="/data/"+b+"?";return c&&(e+="filter="+c),d&&(c&&(e+="&"),e+="page="+d),a.get(e)}}});