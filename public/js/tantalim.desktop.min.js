"use strict";angular.module("tantalim.desktop",["tantalim.common","ngRoute","ui.bootstrap","ngGrid","ngSanitize","ui.select"]),angular.module("tantalim.desktop").factory("keyboardManager",["$window","$timeout",function(a,b){var c={},d={type:"keydown",propagate:!1,inputDisabled:!1,target:a.document,keyCode:!1};return c.keyboardEvent={},c.bind=function(e,f,g){var h,i,j,k;g=angular.extend({},d,g),e=e.toLowerCase(),i=g.target,"string"==typeof g.target&&(i=document.getElementById(g.target)),h=function(c){if(c=c||a.event,g.inputDisabled){var d;if(c.target?d=c.target:c.srcElement&&(d=c.srcElement),3===d.nodeType&&(d=d.parentNode),"INPUT"===d.tagName||"TEXTAREA"===d.tagName)return}c.keyCode?j=c.keyCode:c.which&&(j=c.which);var h=String.fromCharCode(j).toLowerCase();188===j&&(h=","),190===j&&(h=".");for(var i=e.split("+"),l=0,m={"`":"~",1:"!",2:"@",3:"#",4:"$",5:"%",6:"^",7:"&",8:"*",9:"(",0:")","-":"_","=":"+",";":":","'":'"',",":"<",".":">","/":"?","\\":"|"},n={esc:27,escape:27,tab:9,space:32,"return":13,enter:13,backspace:8,scrolllock:145,scroll_lock:145,scroll:145,capslock:20,caps_lock:20,caps:20,numlock:144,num_lock:144,num:144,pause:19,"break":19,insert:45,home:36,"delete":46,end:35,pageup:33,page_up:33,pu:33,pagedown:34,page_down:34,pd:34,left:37,up:38,right:39,down:40,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123},o={shift:{wanted:!1,pressed:c.shiftKey?!0:!1},ctrl:{wanted:!1,pressed:c.ctrlKey?!0:!1},alt:{wanted:!1,pressed:c.altKey?!0:!1},meta:{wanted:!1,pressed:c.metaKey?!0:!1}},p=0,q=i.length;k=i[p],q>p;p++){switch(k){case"ctrl":case"control":l++,o.ctrl.wanted=!0;break;case"shift":case"alt":case"meta":l++,o[k].wanted=!0}k.length>1?n[k]===j&&l++:g.keyCode?g.keyCode===j&&l++:h===k?l++:m[h]&&c.shiftKey&&(h=m[h],h===k&&l++)}return l!==i.length||o.ctrl.pressed!==o.ctrl.wanted||o.shift.pressed!==o.shift.wanted||o.alt.pressed!==o.alt.wanted||o.meta.pressed!==o.meta.wanted||(b(function(){f(c)},1),g.propagate)?void 0:(c.cancelBubble=!0,c.returnValue=!1,c.stopPropagation&&(c.stopPropagation(),c.preventDefault()),!1)},c.keyboardEvent[e]={callback:h,target:i,event:g.type},i.addEventListener?i.addEventListener(g.type,h,!1):i.attachEvent?i.attachEvent("on"+g.type,h):i["on"+g.type]=h},c.unbind=function(a){a=a.toLowerCase();var b=c.keyboardEvent[a];if(delete c.keyboardEvent[a],b){var d=b.event,e=b.target,f=b.callback;e.detachEvent?e.detachEvent("on"+d,f):e.removeEventListener?e.removeEventListener(d,f,!1):e["on"+d]=!1}},c}]),angular.module("tantalim.desktop").config(["$routeProvider",function(a){var b=window.pageName;a.when("/",{templateUrl:"/page/"+b+"/html"}).when("/p/:subPage",{templateUrl:"/page/"+b+"/html"}).when("/search",{templateUrl:"/page/"+b+"/search"}).otherwise({redirectTo:"/"})}]).controller("HeaderController",["$scope","Global","PageService",function(a,b,c){a.global=b,c.getMenu().then(function(b){a.menu=b.data})}]).controller("SearchController",["$scope","$location",function(a,b){var c="{{model.modelName}}";a.submit=function(){b.path("page/"+c)}}]),angular.module("tantalim.desktop").controller("PageController",function(a,b,c,d,e,f,g,h,i){function j(){a.ModelCursor=f,a.current=f.current,a.action=f.action,a.serverStatus=null,i.bind("up",function(){a.currentModel&&a.action.previous(a.currentModel)}),i.bind("down",function(){a.currentModel&&a.action.next(a.currentModel)}),i.bind("ctrl+d",function(){a.currentModel&&a.action.delete(a.currentModel)}),i.bind("ctrl+n",function(){a.currentModel&&a.action.insert(a.currentModel)})}return d.error?(a.serverStatus="",void(a.serverError=d.error)):(c.pageLoaded?j():(console.info("Starting PageController"),c.pageLoaded=!0,a.serverStatus="Loading...",a.serverError="",e.readModelData(d.page.modelName).then(function(b){return a.serverStatus="",200!==b.status?void(a.serverError="Failed to reach server. Try refreshing."):b.data.error?void(a.serverError="Error reading data from server: "+b.data.error):(f.setRoot(d.model,b.data),void j())}),h.setPage(d.page)),a.visibleView=b.subPage?b.subPage:d.page.id,a.changeSubPage=function(b){a.visibleView=b},a.PageCursor=h,a.staticContent=d.staticContent,a.currentModel=d.currentModel,c.modelName=a.currentModel,a.listSmartSelect={},a.runSmartSelect=function(b,c,d){e.queryModelData(b,d).then(function(c){a.listSmartSelect[b]=c.data})},a.chooseSmartSelect=function(a,b,c){f.current.instances[a].selectOption(c,b),f.change(f.current.instances[a])},a.rowChanged=function(a){f.change(a)},a.person={},a.people=[{name:"Adam",email:"adam@email.com",age:10},{name:"Amalie",email:"amalie@email.com",age:12},{name:"Wladimir",email:"wladimir@email.com",age:30},{name:"Samantha",email:"samantha@email.com",age:31},{name:"Estefanía",email:"estefanía@email.com",age:16},{name:"Natasha",email:"natasha@email.com",age:54},{name:"Nicole",email:"nicole@email.com",age:43},{name:"Adrian",email:"adrian@email.com",age:21}],a.address={},a.refreshAddresses=function(b){var c={address:b,sensor:!1};return $http.get("http://maps.googleapis.com/maps/api/geocode/json",{params:c}).then(function(b){a.addresses=b.data.results})},a.save=function(){a.serverStatus="Saving...",g.save(d.model,f.root,function(b){a.serverStatus=b,b||(f.dirty=!1)})},void i.bind("ctrl+s",function(){a.save()}))}),angular.module("tantalim.desktop").factory("PageCursor",function(a){a.debug("Starting PageCursor");var b=function(){},c={pages:{},views:{},current:null,visibleView:null,setPage:b,action:{}};c.setPage=function(a){new d(a),new e(a)};var d=function(a){var b={id:a.id,viewMode:a.viewMode};c.pages[a.id]=b,_.forEach(a.pages,function(a){new d(a)})},e=function(a){var b={id:a.id};c.views[a.id]=b,_.forEach(a.children,function(a){new e(a)}),_.forEach(a.pages,function(a){new e(a)})};return c}),angular.module("tantalim.common",[]),angular.module("tantalim.common").factory("Global",[function(){var a=this;return a._data={pageName:window.pageName,modelName:window.pageName,user:window.user,authenticated:!!window.user},a._data}]),angular.module("tantalim.common").factory("GUID",function(){function a(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return function(){return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()}}),angular.module("tantalim.common").factory("ModelCursor",["$filter","$log","GUID",function(a,b,c){function d(a){var b=a.nodeSet.parentInstance;b&&"NO_CHANGE"===b.state&&(b.state="CHILD_UPDATED",d(b))}var e=null,f={sets:{},instances:{}},g={},h=function(a){g[a.data.modelName]=a,_.forEach(a.children,function(a){h(a)})},i=function(a,b){!b&&a&&(b=a.model.modelName);var c=g[b];f.sets[b]=a;var d=null;if(a&&(d=a.getInstance()),f.instances[b]=d,c&&c.children){var e=function(a){return d&&d.childModels?d.childModels[a]:null};_.forEach(c.children,function(a){var b=a.data.modelName,c=e(b);i(c,b)})}},j=function(a,d,e){function f(a,c){return c.nodeSet.parentInstance?c.nodeSet.parentInstance.data[a]?c.nodeSet.parentInstance.data[a]:f(a,c.nodeSet.parentInstance):(b.error("Cannot find field called "+a),null)}function g(a,c){if(a.fieldDefault){if(a.fieldDefault.value)return void(c.data[a.fieldName]=a.fieldDefault.value);if(a.fieldDefault.fromField)return void(c.data[a.fieldName]=f(a.fieldDefault.fromField,c));if(a.fieldDefault.fxn)return console.info("running fxn"),void(c.data[a.fieldName]=a.fieldDefault.fxn);b.debug("No valid default found"),b.debug(a)}}var h={_type:"SmartNodeInstance",id:null,data:{},nodeSet:null,childModels:{},state:"NO_CHANGE","delete":function(){this.state="DELETED"},update:function(){"NO_CHANGE"===this.state&&(this.state="UPDATED")},selectOption:function(a,b){var c=this;_.forEach(b,function(b){c.data[b.to]=a.data[b.from]})}},i=_.defaults(d,h);return i.nodeSet=e,null===d.id?(i.state="INSERTED",i.id=c(),_.forEach(a.fields,function(a){g(a,d)}),b.debug(d),i):(d.children&&_.forEach(a.children,function(a){var b=a.data.modelName,c=d.children[b],e=new k(a,c,i);i.childModels[b]=e}),i)},k=function(c,e,f){var g={_type:"SmartNodeSet",model:{modelName:null,parentInstance:null,orderBy:null,childModels:[]},parent:{instance:null,model:null},currentIndex:-1,rows:[],deleted:[],sort:function(b){var c=this.model.orderBy;angular.isString(c)&&(c="data."+c),this.rows=a("orderBy")(this.rows,c,b)},sortReverse:function(){this.sort(!0)},moveTo:function(a){0>a||a>=this.rows.length||(this.currentIndex=a,i(this))},moveNext:function(){this.moveTo(this.currentIndex+1)},movePrevious:function(){this.moveTo(this.currentIndex-1)},moveToTop:function(){this.moveTo(0)},moveToBottom:function(){this.moveTo(this.rows.length-1)},"delete":function(a){if(!(this.rows.length<=0)){var b=this.getInstance(a).id,c=_.remove(this.rows,function(a){return a.id===b});c=_.remove(c,function(a){return"INSERTED"!==a.state}),c&&c.length>0&&(d(c[0]),this.deleted.push(c[0])),this.currentIndex>=this.rows.length&&(this.currentIndex=this.rows.length-1),i(this)}},getInstance:function(a){return a||(a=this.currentIndex),(!a||0>a)&&(a=0),this.rows&&0!==this.rows.length?this.rows[a]:null},reloadFromServer:function(a){b.debug("reloadFromServer"),b.debug(a),b.debug(this),_.forEach(this.rows,function(c){var d;switch(c.state){case"INSERTED":b.debug(c),d=_.find(a,function(a){return a.tempID===c.id}),d?(c.state="NO_CHANGE",c.data=d.data,c.id=d.id):(console.error("Failed to find matching inserted row"),console.error(c));break;case"UPDATED":b.debug(c),d=_.find(a,function(a){return a.id===c.id}),d?(c.state="NO_CHANGE",c.data=d.data):(console.error("Failed to find matching updated row"),console.error(c))}}),this.deleted.length=0}},h=_.defaults({},g);return h.model.modelName=c.data.modelName,h.model.orderBy=c.orderBy,h.parentInstance=f,h.insert=function(){var a=new j(c,{},h);h.rows.push(a),h.moveToBottom(),d(a)},angular.isArray(e)?(_.forEach(e,function(a){var b=new j(c,a,h);h.rows.push(b)}),h.rows.length&&(h.currentIndex=0)):(console.warn("SmartNodeSet expected data to be array but got the following:"),console.warn(e)),h},l={root:e,current:f,setRoot:function(a,c){b.debug("Setting Root data"),b.debug(a),b.debug(c),g={},h(a),e=new k(a,c),l.root=e,i(e),l.current=f},dirty:!1,change:function(a){("NO_CHANGE"===a.state||"CHILD_UPDATED"===a.state)&&(a.state="UPDATED",d(a),l.dirty=!0)},action:{insert:function(a){f.sets[a].insert(),l.dirty=!0},"delete":function(a,b){f.sets[a].delete(b),l.dirty=!0},select:function(a,b){f.sets[a].moveTo(b)},previous:function(a){f.sets[a].movePrevious()},next:function(a){f.sets[a].moveNext()}}};return l}]),angular.module("tantalim.common").factory("ModelSaver",["$http","$log",function(a,b){var c,d={convertToDto:function(a,c){var e=a.data.modelName;b.debug("Starting convertToDto for model "+e),b.debug(a);var f=function(a){return{state:a.state,tempID:a.id,data:a.data}},g=function(a){return{state:a.state,id:a.id,data:a.data}},h=function(a){return{state:"DELETED",id:a.id}},i=function(a,b,c){var e=!1;a.children={},_.forEach(b.children,function(b){var f=b.data.modelName,g=d.convertToDto(b,c.childModels[f]);g.length>0&&(a.children[f]=g,e=!0)}),e||delete a.children},j=[];return c?(b.debug(c),_.forEach(c.rows,function(b){var c={};c="INSERTED"===b.state?f(b):"UPDATED"===b.state?g(b):"CHILD_UPDATED"===b.state?g(b):null,c&&(j.push(c),i(c,a,b))}),_.forEach(c.deleted,function(b){var c=h(b);j.push(c),i(c,a,b)}),j):(b.debug("dataSet is empty so exit"),j)},sendData:function(d,e,f){b.debug("sendData()..."),b.debug(e),a.post("/data/"+d,e).success(function(a,b){200===b?a.error?f("Failed to save data "+a.error):(c.reloadFromServer(a),f()):(f("Failed "+b),console.error(b),console.error(a))}).error(function(a,b){404===b&&f("Server not found. Check your Internet connection and try again."),console.error(b),console.error(a)})},save:function(a,e,f){c=e,b.debug("Starting ModelSaver.save");var g=d.convertToDto(a,c);d.sendData(a.data.modelName,g,f)}};return d}]),angular.module("tantalim.common").factory("PageService",function(a){return{readModelData:function(b){return a.get("/data/"+b)},queryModelData:function(b,c){return a.get("/data/"+b+"/q/"+c)},getMenu:function(){return a.get("/menu/")}}});