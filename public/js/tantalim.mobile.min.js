"use strict";angular.module("tantalim.mobile",["tantalim.common","ngRoute","mobile-angular-ui"]),angular.module("tantalim.mobile").config(["$routeProvider",function(a){var b=window.pageName;a.when("/",{templateUrl:"/m/"+b+"/list",controller:"PageController"}).when("/detail/:subPage/:id",{templateUrl:"/m/"+b+"/detail",controller:"PageController"}).when("/list/:subPage",{templateUrl:"/m/"+b+"/list",controller:"PageController"}).otherwise({redirectTo:"/"})}]),angular.module("tantalim.mobile").controller("PageController",function(a,b,c,d,e,f,g){function h(){a.ModelCursor=e,a.current=e.current,a.action=e.action}return a.loading=!0,d.error?(a.serverStatus="",void(a.serverError=d.error)):(c.pageLoaded?(h(),a.loading=!1,a.serverStatus=""):(c.pageLoaded=!0,a.serverStatus="Loading...",a.serverError="",g.readModelData(d.page.modelName).then(function(b){return a.serverStatus="",a.loading=!1,200!==b.status?void(a.serverError="Failed to reach server. Try refreshing."):b.data.error?void(a.serverError="Error reading data from server: "+b.data.error):(e.setRoot(d.model,b.data),void h())})),a.staticContent=d.staticContent,a.currentModel=d.currentModel,c.modelName=a.currentModel,a.currentPage="list-"+d.page.id,b.subPage&&(b.id?(a.currentPage="detail-"+b.subPage,e.action.choose(b.subPage,b.id)):a.currentPage="list-"+b.subPage),a.isActive=function(a){return a===c.pageName},a.rowChanged=function(a){e.change(a)},void(a.save=function(){a.serverStatus="Saving...",f.save(d.model,e.root,function(b){a.serverStatus=b,b||(e.dirty=!1)})}))}),angular.module("tantalim.common",[]),angular.module("tantalim.common").factory("Global",[function(){return{pageName:window.pageName,modelName:window.pageName,user:window.user,authenticated:!!window.user}}]),angular.module("tantalim.common").factory("GUID",function(){function a(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return function(){return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()}}),angular.module("tantalim.common").factory("Logger",[function(){function a(a){return"string"==typeof a?{message:a}:a}var b={TYPE:{INFO:"info",WARN:"warn",ERROR:"warn",DEBUG:"debug"},history:[],log:function(c,d){c=a(c),c.type=d||b.TYPE.INFO,c.type===b.TYPE.ERROR?b._error=c.message:b._status=c.message,b.history.push(c)},info:function(a){b.log(a)},warn:function(a){b.log(a,b.TYPE.WARN)},debug:function(a){b.log(a,b.TYPE.DEBUG)},error:function(a){b.log(a,b.TYPE.ERROR)},getStatus:function(){return b._status},getError:function(){return b._error}};return b}]),angular.module("tantalim.common").factory("ModelCursor",["$filter","$log","GUID",function($filter,$log,GUID){var rootSet,current,modelMap,clear=function(){rootSet=null,current={},modelMap={}};clear();var fillModelMap=function(a,b){modelMap[a.name]=a,a.parent=b,_.forEach(a.children,function(b){fillModelMap(b,a.name)})},STATE={NO_CHANGE:"NO_CHANGE",DELETED:"DELETED",INSERTED:"INSERTED",UPDATED:"UPDATED",CHILD_UPDATED:"CHILD_UPDATED"},SmartNodeInstance=function(model,row,nodeSet){function setFieldDefault(field,row){var defaultValue;if(null!==field.valueDefault)switch(console.info(field.name+field.valueDefault),defaultValue=field.valueDefault,field.dataType){case"Boolean":defaultValue="true"===defaultValue}null!==field.fieldDefault&&(defaultValue=row.getValue(field.fieldDefault)),null!==field.functionDefault&&(defaultValue=eval(field.functionDefault)),void 0!==defaultValue&&($log.debug("defaulted "+field.name+" to "+defaultValue+" of type "+typeof defaultValue),row.data[field.name]=defaultValue)}var defaults={_type:"SmartNodeInstance",id:null,data:{},nodeSet:null,childModels:{},getChild:function(a){var b=this.childModels[a];return void 0===b&&console.warn("Child model "+a+" doesn't exist."),b},state:STATE.NO_CHANGE,"delete":function(){this.state=STATE.DELETED},isDirty:function(){return this.state!==STATE.NO_CHANGE},toggle:function(a,b){var c=this.data[a],d=!0;c===!0&&(d=!1),void 0===c&&(d=!0),c===!1&&(d=b?!0:null),console.info("Setting ",a,d),this.update(a,d)},getField:function(a){var b=modelMap[this.nodeSet.model.modelName];return b.fields[a]},getValue:function(a){if(this.data.hasOwnProperty(a))return this.data[a];if(this.getField(a))return null;if(this.nodeSet.parentInstance)return this.nodeSet.parentInstance.getValue(a);throw new Error("Cannot find field called "+a)},setValue:function(a,b,c){console.info("update "+a+" to "+b),c=c||!1;var d=modelMap[nodeSet.model.modelName].fields[a];d||console.error("Failed to find field named "+a+" in ",modelMap[nodeSet.model.modelName].fields),(d.updateable||c)&&(a&&("TableName"===a&&b&&(this.data.TableSQL="app_"+this.data[a].toLowerCase()),void 0!==b&&(this.data[a]=b)),(this.state===STATE.NO_CHANGE||this.state===STATE.CHILD_UPDATED)&&(this.state=STATE.UPDATED,this.updateParent()))},update:function(a,b,c){console.warn("update is deprecated. Use setValue"),this.setValue(a,b,c)},updateParent:function(){if(this.nodeSet){var a=this.nodeSet.parentInstance;a&&a.state===STATE.NO_CHANGE&&(a.state=STATE.CHILD_UPDATED,a.updateParent())}},isFieldEditable:function(){return!0}},newInstance=_.defaults(row,defaults);return newInstance.nodeSet=nodeSet,null===row.id&&(newInstance.state=STATE.INSERTED,newInstance.id=GUID(),_.forEach(model.fields,function(a){setFieldDefault(a,row)})),newInstance.addChildModel=function(a,b){var c=new SmartNodeSet(modelMap[a],b,newInstance,nodeSet.depth+1);newInstance.childModels[a]=c},_.forEach(model.children,function(a){row.children?newInstance.addChildModel(a.name,row.children[a.name]):newInstance.addChildModel(a.name,[])}),newInstance},SmartNodeSet=function(a,b,c,d){var e={_type:"SmartNodeSet",model:{modelName:null,parentInstance:null,orderBy:null,childModels:[]},parent:{instance:null,model:null},rows:[],deleted:[],depth:d||0,index:-1,sort:function(a,b){this.rows=$filter("orderBy")(this.rows,"data."+a,b)},sortReverse:function(){this.sort(!0)},moveTo:function(a){0>a||a>=this.rows.length||(this.index=a,self.resetCurrents(this))},movePrevious:function(){this.moveTo(this.index-1)},moveNext:function(){this.moveTo(this.index+1)},hasPrevious:function(){return this.index>0},hasNext:function(){return this.index+1<this.rows.length},findIndex:function(a){return _.findIndex(this.rows,function(b){return b.id===a})},find:function(a){return _.find(this.rows,a)},isEmpty:function(){return!(this.rows.length>0)},max:function(a,b){if(this.isEmpty())return b;var c=_.max(this.rows,function(b){return Number(b.data[a])});return c?Number(c.data[a]):b},min:function(a,b){if(this.isEmpty())return b;var c=_.min(this.rows,function(b){return Number(b.data[a])});return c?Number(c.data[a]):b},isDirty:function(){if(this.deleted&&this.deleted.length>0)return!0;var a=_.find(this.rows,function(a){return a.isDirty()});return!_.isEmpty(a)},"delete":function(a){var b=this.rows[a];b.state!==STATE.INSERTED&&(this.deleted.push(b),b.updateParent()),this.rows.splice(a,1),self.clearCurrentChildren(this.model.modelName)},deleteEnabled:function(){return null!==this.getInstance()},getInstance:function(a){return this.rows&&0!==this.rows.length?(this.index<0&&(this.index=0),a=a||this.index||0,this.rows[a]):(this.index=-1,null)},reloadFromServer:function(a){$log.debug("reloadFromServer with returned data",a),$log.debug("this set",this),_.forEach(this.rows,function(b){var c;switch(b.state){case STATE.INSERTED:c=_.find(a,function(a){return a.tempID===b.id}),$log.debug("matching inserted row",b,c),c?(b.state=STATE.NO_CHANGE,b.data=c.data,b.id=c.id):console.error("Failed to find matching inserted row",b);break;case STATE.UPDATED:case STATE.CHILD_UPDATED:c=_.find(a,function(a){return a.id===b.id}),$log.debug("matching update or child_updated row",b,c),c?(b.state=STATE.NO_CHANGE,b.state===STATE.UPDATED&&(b.data=c.data)):console.error("Failed to find matching updated row",b)}b.childModels&&c&&c.children&&_.forEach(b.childModels,function(a,d){var e=c.children[d];e&&b.childModels[d].reloadFromServer(e)})}),this.deleted=[]}},f=_.defaults({},e);return f.model.modelName=a.name,f.model.orderBy=a.orderBy,f.parentInstance=c,f.insert=function(b){$log.debug("Inserting new instance with model");var c=new SmartNodeInstance(a,{data:b||{}},f);return f.rows.push(c),f.index=f.rows.length-1,c.updateParent(),self.resetCurrents(f),c},angular.isArray(b)&&(_.forEach(b,function(b){var c=new SmartNodeInstance(a,b,f);f.rows.push(c)}),self.resetCurrents(f)),f},self={root:rootSet,current:current,setRoot:function(a,b){return $log.debug("Setting Root data"),$log.debug(a),$log.debug(b),clear(),self.current=current,_.isEmpty(a)?void console.warn("setRoot called with empty model, exiting"):(fillModelMap(a),rootSet=new SmartNodeSet(a,b),self.root=rootSet,void self.resetCurrents(rootSet))},getCurrentSet:function(a){return!_.isEmpty(self.current)&&!self.current[a],self.current[a]},resetCurrents:function(a){if(!a||"SmartNodeSet"!==a._type)throw new Error("resetCurrents() requires a SmartNodeSet but got",a);var b=a.model.modelName,c=modelMap[b];self.clearCurrentChildren(c),self.current[b]=a;var d=a.getInstance();c&&c.children&&_.forEach(c.children,function(a){if(d&&d.childModels){var b=d.childModels[a.name];b&&self.resetCurrents(b)}})},clearCurrentChildren:function(a){a.children&&_.forEach(a.children,function(a){current[a.name]=null,self.clearCurrentChildren(a)})},dirty:function(){return rootSet?rootSet.isDirty():!1},toConsole:function(){console.log("ModelCursor.rootSet",self.root),console.log("ModelCursor.modelMap",modelMap),console.log("ModelCursor.current",self.current)}};return self}]),angular.module("tantalim.common").factory("ModelSaver",["$http","$log",function(a,b){var c,d={convertToDto:function(a,c){var e=(a.name,function(a){return{state:a.state,tempID:a.id,data:a.data}}),f=function(a){return{state:a.state,id:a.id,data:a.data}},g=function(a){return{state:"DELETED",id:a.id}},h=function(a,b,c){var e=!1;a.children={},_.forEach(b.children,function(b){var f=b.name,g=d.convertToDto(b,c.childModels[f]);g.length>0&&(a.children[f]=g,e=!0)}),e||delete a.children},i=[];return c?(b.debug(c),_.forEach(c.rows,function(b){var c={};c="INSERTED"===b.state?e(b):"UPDATED"===b.state?f(b):"CHILD_UPDATED"===b.state?f(b):null,c&&(i.push(c),h(c,a,b))}),_.forEach(c.deleted,function(b){var c=g(b);i.push(c),h(c,a,b)}),i):(b.debug("dataSet is empty so exit"),i)},sendData:function(d,e,f){b.debug("sendData()..."),b.debug(e),a.post("/data/"+d,e).success(function(a,d){b.debug("Returned success"),b.debug(d),200===d?a.error?f("Failed to save data "+a.error.message):(c.reloadFromServer(a),f("")):(f("Failed "+d),console.error(d),console.error(a))}).error(function(a,b){f(404===b?"Server not found. Check your Internet connection and try again.":"Server returned an unknown "+b+" error")})},save:function(a,e,f){c=e,b.debug("Starting ModelSaver.save");var g=d.convertToDto(a,c);d.sendData(a.name,g,f)}};return d}]),angular.module("tantalim.common").factory("PageService",function(a){var b={readModelData:function(a,c,d){var e="/data/"+a+"?";return c&&(e+="filter="+c),d&&(c&&(e+="&"),e+="page="+d),b.readUrl(e)},readUrl:function(b){return a.get(b)}};return b});