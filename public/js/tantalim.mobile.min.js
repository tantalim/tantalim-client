"use strict";angular.module("tantalim.mobile",["tantalim.common","ngRoute","mobile-angular-ui"]),angular.module("tantalim.mobile").config(["$routeProvider",function(a){var b=window.pageName;a.when("/",{templateUrl:"/m/"+b+"/list",controller:"PageController"}).when("/detail/:subPage/:id",{templateUrl:"/m/"+b+"/detail",controller:"PageController"}).when("/list/:subPage",{templateUrl:"/m/"+b+"/list",controller:"PageController"}).otherwise({redirectTo:"/"})}]),angular.module("tantalim.mobile").controller("PageController",function(a,b,c,d,e,f,g){function h(){a.ModelCursor=e,a.current=e.current,a.action=e.action}return a.loading=!0,d.error?(a.serverStatus="",void(a.serverError=d.error)):(c.pageLoaded?(h(),a.loading=!1,a.serverStatus=""):(c.pageLoaded=!0,a.serverStatus="Loading...",a.serverError="",g.readModelData(d.page.modelName).then(function(b){return a.serverStatus="",a.loading=!1,200!==b.status?void(a.serverError="Failed to reach server. Try refreshing."):b.data.error?void(a.serverError="Error reading data from server: "+b.data.error):(e.setRoot(d.model,b.data),void h())})),a.staticContent=d.staticContent,a.currentModel=d.currentModel,c.modelName=a.currentModel,a.currentPage="list-"+d.page.id,b.subPage&&(b.id?(a.currentPage="detail-"+b.subPage,e.action.choose(b.subPage,b.id)):a.currentPage="list-"+b.subPage),a.isActive=function(a){return a===c.pageName},a.rowChanged=function(a){e.change(a)},void(a.save=function(){a.serverStatus="Saving...",f.save(d.model,e.root,function(b){a.serverStatus=b,b||(e.dirty=!1)})}))}),angular.module("tantalim.common",[]),angular.module("tantalim.common").factory("Global",[function(){return{pageName:window.pageName,modelName:window.pageName,user:window.user,authenticated:!!window.user}}]),angular.module("tantalim.common").factory("GUID",function(){function a(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return function(){return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()}}),angular.module("tantalim.common").factory("Logger",[function(){var a=[],b={Message:function(){return this},log:function(b){a.push(b)}};return b}]),angular.module("tantalim.common").factory("ModelCursor",["$filter","$log","GUID",function($filter,$log,GUID){function getRows(a,b){var c=a.rows.start,d=1+a.rows.end;b>d-c&&(d=c+b);var e=current.sets[a.model].rows;return _.slice(e,c,d)}var rootSet,current,modelMap,clipboard,clear=function(){rootSet=null,current={sets:{},instances:{},gridSelection:{},editing:{}},modelMap={},clipboard={}};clear();var MOUSE={LEFT:1,RIGHT:3},fillModelMap=function(a,b){modelMap[a.name]=a,a.parent=b,_.forEach(a.children,function(b){fillModelMap(b,a.name)})},resetCurrents=function(a,b){!b&&a&&(b=a.model.modelName);var c=modelMap[b];current.sets[b]=a;var d=null;if(a&&(d=a.getInstance()),current.instances[b]=d,c&&c.children){var e=function(a){return d&&d.childModels?d.childModels[a]:null};_.forEach(c.children,function(a){var b=a.name,c=e(b);resetCurrents(c,b)})}},SmartNodeInstance=function(model,row,nodeSet){function setFieldDefault(field,row){if(field.fieldDefault){$log.debug("Defaulting field ",field);var DEFAULT_TYPE={CONSTANT:"Constant",FIELD:"Field",FXN:"Fxn"};switch(field.fieldDefault.type){case DEFAULT_TYPE.FIELD:row.data[field.name]=row.getValue(field.fieldDefault.value);break;case DEFAULT_TYPE.FXN:row.data[field.name]=eval(field.fieldDefault.value);break;case DEFAULT_TYPE.CONSTANT:var value=field.fieldDefault.value;switch(field.dataType){case"Boolean":value="true"===value}row.data[field.name]=value;break;default:console.error("Failed to match fieldDefault.type on ",field)}$log.debug("defaulted "+field.name+" to "+row.data[field.name]+" of type "+typeof row.data[field.name])}}$log.debug("Adding SmartNodeInstance id:%s for model `%s` onto set ",row.id,model.name,nodeSet);var defaults={_type:"SmartNodeInstance",id:null,data:{},nodeSet:null,childModels:{},state:"NO_CHANGE","delete":function(){this.state="DELETED"},isDirty:function(){return"NO_CHANGE"!==this.state},toggle:function(a,b){var c=this.data[a],d=!0;c===!0&&(d=!1),void 0===c&&(d=!0),c===!1&&(d=b?!0:null),console.info("Setting ",a,d),this.update(a,d)},getValue:function(a){if(console.info("finding value for fieldName: ",a,this.data),this.data.hasOwnProperty(a))return this.data[a];if(this.nodeSet.parentInstance)return this.nodeSet.parentInstance.getValue(a);throw new Error("Cannot find field called "+a)},update:function(a,b){var c=modelMap[nodeSet.model.modelName].fields[a];c||console.error("Failed to find field named "+a+" in ",modelMap[nodeSet.model.modelName].fields),c.updateable&&(a&&("TableName"===a&&b&&(this.data.TableSQL="app_"+this.data[a].toLowerCase()),void 0!==b&&(this.data[a]=b)),("NO_CHANGE"===this.state||"CHILD_UPDATED"===this.state)&&(this.state="UPDATED",this.updateParent()))},updateParent:function(){if(this.nodeSet){console.info(this);var a=this.nodeSet.parentInstance;a&&"NO_CHANGE"===a.state&&(a.state="CHILD_UPDATED",a.updateParent())}}},newInstance=_.defaults(row,defaults);return newInstance.nodeSet=nodeSet,null===row.id&&($log.debug("id is null, so assume record is newly inserted",row),newInstance.state="INSERTED",newInstance.id=GUID(),_.forEach(model.fields,function(a){setFieldDefault(a,row)})),newInstance.addChildModel=function(a,b){var c=new SmartNodeSet(modelMap[a],b,newInstance);newInstance.childModels[a]=c},row.children&&_.forEach(model.children,function(a){newInstance.addChildModel(a.name,row.children[a.name])}),$log.debug("Done creating newInstance"),newInstance},SmartNodeSet=function(a,b,c){$log.debug("Adding SmartNodeSet for "+a.name);var d={_type:"SmartNodeSet",model:{modelName:null,parentInstance:null,orderBy:null,childModels:[]},parent:{instance:null,model:null},currentIndex:-1,rows:[],deleted:[],sort:function(a){var b=this.model.orderBy;angular.isString(b)&&(b="data."+b),this.rows=$filter("orderBy")(this.rows,b,a)},sortReverse:function(){this.sort(!0)},moveTo:function(a){0>a||a>=this.rows.length||(this.currentIndex=a,resetCurrents(this))},moveNext:function(){this.moveTo(this.currentIndex+1)},movePrevious:function(){this.moveTo(this.currentIndex-1)},moveToTop:function(){this.moveTo(0)},moveToBottom:function(){this.moveTo(this.rows.length-1)},findIndex:function(a){return _.findIndex(this.rows,function(b){return b.id===a})},isDirty:function(){if(this.deleted&&this.deleted.length>0)return!0;var a=_.find(this.rows,function(a){return a.isDirty()});return!_.isEmpty(a)},"delete":function(a){if(!(this.rows.length<=0)){var b=this.getInstance(a).id,c=_.remove(this.rows,function(a){return a.id===b});c=_.remove(c,function(a){return"INSERTED"!==a.state}),c&&c.length>0&&(c[0].updateParent(),this.deleted.push(c[0])),this.currentIndex>=this.rows.length&&(this.currentIndex=this.rows.length-1),resetCurrents(this)}},getInstance:function(a){return a||(a=this.currentIndex),(!a||0>a)&&(a=0),this.rows&&0!==this.rows.length?this.rows[a]:null},reloadFromServer:function(a){$log.debug("reloadFromServer"),$log.debug(a),$log.debug(this),_.forEach(this.rows,function(b){var c;switch(b.state){case"INSERTED":$log.debug(b),c=_.find(a,function(a){return a.tempID===b.id}),c?(b.state="NO_CHANGE",b.data=c.data,b.id=c.id):console.error("Failed to find matching inserted row",b);break;case"UPDATED":$log.debug(b),c=_.find(a,function(a){return a.id===b.id}),c?(b.state="NO_CHANGE",b.data=c.data):console.error("Failed to find matching updated row",b)}}),this.deleted.length=0}},e=_.defaults({},d);return e.model.modelName=a.name,e.model.orderBy=a.orderBy,e.parentInstance=c,e.insert=function(){$log.debug("Inserting new instance with model");var b=new SmartNodeInstance(a,{},e);return e.rows.push(b),e.moveToBottom(),b.updateParent(),b},angular.isArray(b)&&(_.forEach(b,function(b){var c=new SmartNodeInstance(a,b,e);e.rows.push(c)}),e.rows.length&&(e.currentIndex=0)),e},self={root:rootSet,current:current,setRoot:function(a,b){return $log.debug("Setting Root data"),clear(),_.isEmpty(a)?void console.warn("setRoot called with empty model, exiting"):(fillModelMap(a),rootSet=new SmartNodeSet(a,b),self.root=rootSet,resetCurrents(rootSet),void(self.current=current))},getCurrentInstance:function(a){return current.instances[a]},getCurrentSet:function(a){if(void 0===current.sets[a]){$log.debug("current set for %s hasn't been created yet, creating now.",a);var b=modelMap[a].parent,c=current.instances[b];c.addChildModel(a),resetCurrents(self.root)}return current.sets[a]},dirty:function(){return rootSet.isDirty()},toConsole:function(){console.log("ModelCursor.rootSet",self.root),console.log("ModelCursor.modelMap",modelMap),console.log("ModelCursor.current",self.current)},action:{length:function(a){return _.isEmpty(current.sets[a])?0:current.sets[a].rows.length},insert:function(a){var b=self.getCurrentSet(a).insert();return b},"delete":function(a,b){current.sets[a]["delete"](b)},deleteSelected:function(a){if(current.gridSelection.model===a){for(var b=current.gridSelection.rows.start;b<=current.gridSelection.rows.end;b++)current.sets[a]["delete"](current.gridSelection.rows.start);current.sets[a].rows.length>0?current.gridSelection.rows.end=current.gridSelection.rows.start:current.gridSelection={}}},deleteEnabled:function(a){return null!==current.instances[a]},choose:function(a,b){var c=current.sets[a].findIndex(b);current.sets[a].moveTo(c)},select:function(a,b){current.sets[a].moveTo(b)},previous:function(a){current.sets[a].movePrevious()},next:function(a){current.sets[a].moveNext()},dblclick:function(a,b,c){if(event.which===MOUSE.LEFT){var d=modelMap[a].fields[c],e=current.sets[a].getInstance(b);console.info(e),console.info(d),("INSERTED"===e.state||d.updateable)&&(current.editing={},current.editing[a]={row:b,column:c},current.focus=a+"_"+c+"_"+b)}},focus:function(a,b,c){return self.action.cellIsEditing(a,b,c)?current.focus===a+"_"+c+"_"+b:!1},cellIsEditing:function(a,b,c){return current.editing[a]&&current.editing[a].row===b&&current.editing[a].column===c},escape:function(){current.editing={}},mousedown:function(a,b,c){if(event.which===MOUSE.LEFT){if(self.action.cellIsEditing(a,b,c))return;current.editing={},current.gridSelection={selecting:!0,model:a,rows:{start:b,end:b},columns:{}},self.action.mouseover(a,b,c),self.action.select(a,b)}},mouseover:function(a,b,c){if(event.which===MOUSE.LEFT){if(self.action.cellIsEditing(a,b,c))return;current.gridSelection.selecting&&(a===current.gridSelection.model&&(current.gridSelection.rows.end=b,current.gridSelection.columns[c]=!0),event.preventDefault(),event.stopPropagation())}},mouseup:function(){event.which===MOUSE.LEFT&&(current.gridSelection.selecting=!1)},cellIsSelected:function(a,b,c){return current.gridSelection.model===a&&current.gridSelection.rows.start<=b&&current.gridSelection.rows.end>=b&&current.gridSelection.columns[c]},copy:function(){current.gridSelection&&(clipboard=_.cloneDeep(current.gridSelection))},paste:function(){if(clipboard&&current.gridSelection){var a=getRows(clipboard),b=getRows(current.gridSelection),c=0;_.forEach(b,function(b){c>=a.length&&(c=0);var d=a[c];_.forEach(current.gridSelection.columns,function(a,c){b.update(c,d.data[c])}),c++})}}}};return self}]),angular.module("tantalim.common").factory("ModelSaver",["$http","$log",function(a,b){var c,d={convertToDto:function(a,c){var e=(a.name,function(a){return{state:a.state,tempID:a.id,data:a.data}}),f=function(a){return{state:a.state,id:a.id,data:a.data}},g=function(a){return{state:"DELETED",id:a.id}},h=function(a,b,c){var e=!1;a.children={},_.forEach(b.children,function(b){var f=b.name,g=d.convertToDto(b,c.childModels[f]);g.length>0&&(a.children[f]=g,e=!0)}),e||delete a.children},i=[];return c?(b.debug(c),_.forEach(c.rows,function(b){var c={};c="INSERTED"===b.state?e(b):"UPDATED"===b.state?f(b):"CHILD_UPDATED"===b.state?f(b):null,c&&(i.push(c),h(c,a,b))}),_.forEach(c.deleted,function(b){var c=g(b);i.push(c),h(c,a,b)}),i):(b.debug("dataSet is empty so exit"),i)},sendData:function(d,e,f){b.debug("sendData()..."),b.debug(e),a.post("/data/"+d,e).success(function(a,d){b.debug("Returned success"),b.debug(d),200===d?a.error?f("Failed to save data "+a.error.message):(c.reloadFromServer(a),f("")):(f("Failed "+d),console.error(d),console.error(a))}).error(function(a,b){f(404===b?"Server not found. Check your Internet connection and try again.":"Server returned an unknown "+b+" error")})},save:function(a,e,f){c=e,b.debug("Starting ModelSaver.save");var g=d.convertToDto(a,c);d.sendData(a.name,g,f)}};return d}]),angular.module("tantalim.common").factory("PageService",function(a){return{readModelData:function(b,c,d){var e="/data/"+b+"?";return c&&(e+="filter="+c),d&&(c&&(e+="&"),e+="page="+d),a.get(e)}}});