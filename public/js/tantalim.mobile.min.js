"use strict";angular.module("tantalim.mobile",["tantalim.common","ngRoute","mobile-angular-ui"]),angular.module("tantalim.mobile").config(["$routeProvider",function(a){var b=window.pageName;a.when("/",{templateUrl:"/m/"+b+"/list",controller:"PageController"}).when("/detail/:subPage/:id",{templateUrl:"/m/"+b+"/detail",controller:"PageController"}).when("/list/:subPage",{templateUrl:"/m/"+b+"/list",controller:"PageController"}).otherwise({redirectTo:"/"})}]),angular.module("tantalim.mobile").controller("PageController",function(a,b,c,d,e,f,g){function h(){a.ModelCursor=e,a.current=e.current,a.action=e.action}return a.loading=!0,d.error?(a.serverStatus="",void(a.serverError=d.error)):(c.pageLoaded?(h(),a.loading=!1,a.serverStatus=""):(c.pageLoaded=!0,a.serverStatus="Loading...",a.serverError="",g.readModelData(d.page.modelName).then(function(b){return a.serverStatus="",a.loading=!1,200!==b.status?void(a.serverError="Failed to reach server. Try refreshing."):b.data.error?void(a.serverError="Error reading data from server: "+b.data.error):(e.setRoot(d.model,b.data),void h())})),a.staticContent=d.staticContent,a.currentModel=d.currentModel,c.modelName=a.currentModel,a.currentPage="list-"+d.page.id,b.subPage&&(b.id?(a.currentPage="detail-"+b.subPage,e.action.choose(b.subPage,b.id)):a.currentPage="list-"+b.subPage),a.isActive=function(a){return a===c.pageName},a.rowChanged=function(a){e.change(a)},void(a.save=function(){a.serverStatus="Saving...",f.save(d.model,e.root,function(b){a.serverStatus=b,b||(e.dirty=!1)})}))}),angular.module("tantalim.common",[]),angular.module("tantalim.common").factory("Global",[function(){return{pageName:window.pageName,modelName:window.pageName,user:window.user,authenticated:!!window.user}}]),angular.module("tantalim.common").factory("GUID",function(){function a(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return function(){return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()}}),angular.module("tantalim.common").factory("ModelCursor",["$filter","$log","GUID",function(a,b,c){function d(a){var b=a.nodeSet.parentInstance;b&&"NO_CHANGE"===b.state&&(b.state="CHILD_UPDATED",d(b))}var e,f,g,h=function(){e=null,f={sets:{},instances:{}},g={}};h();var i=function(a,b){if(a&&a.data){var c=a.name;g[c]=a,a.parent=b,_.forEach(a.children,function(a){i(a,c)})}},j=function(a,b){!b&&a&&(b=a.model.modelName);var c=g[b];f.sets[b]=a;var d=null;if(a&&(d=a.getInstance()),f.instances[b]=d,c&&c.children){var e=function(a){return d&&d.childModels?d.childModels[a]:null};_.forEach(c.children,function(a){var b=a.name,c=e(b);j(c,b)})}},k=function(a,d,e){function f(a,c){return c.nodeSet.parentInstance?c.nodeSet.parentInstance.data[a]?c.nodeSet.parentInstance.data[a]:f(a,c.nodeSet.parentInstance):(b.error("Cannot find field called "+a),null)}function g(a,c){if(a.fieldDefault){var d={CONSTANT:"constant",FIELD:"field",FXN:"fxn"};switch(a.fieldDefault.type){case d.FIELD:return c.data[a.fieldName]=f(a.fieldDefault.value,c),void b.debug("defaulted "+a.fieldName+" to "+c.data[a.fieldName]);case d.FXN:return console.info("running fxn - NOT SUPPORTED YET"),void(c.data[a.fieldName]=a.fieldDefault.value);case d.CONSTANT:default:return c.data[a.fieldName]=a.fieldDefault.value,void b.debug("defaulted "+a.fieldName+" to "+c.data[a.fieldName])}}}var h={_type:"SmartNodeInstance",id:null,data:{},nodeSet:null,childModels:{},state:"NO_CHANGE","delete":function(){this.state="DELETED"},update:function(){"NO_CHANGE"===this.state&&(this.state="UPDATED")}},i=_.defaults(d,h);return i.nodeSet=e,null===d.id?(i.state="INSERTED",i.id=c(),_.forEach(a.fields,function(a){g(a,d)}),i):(i.addChildModel=function(a,b){var c=a.name,d=new l(a,b,i);i.childModels[c]=d},d.children&&_.forEach(a.children,function(a){var b=a.name;i.addChildModel(a,d.children[b])}),i)},l=function(c,e,f){console.debug("Adding SmartNodeSet for "+c.name),console.debug(c);var g={_type:"SmartNodeSet",model:{modelName:null,parentInstance:null,orderBy:null,childModels:[]},parent:{instance:null,model:null},currentIndex:-1,rows:[],deleted:[],sort:function(b){var c=this.model.orderBy;angular.isString(c)&&(c="data."+c),this.rows=a("orderBy")(this.rows,c,b)},sortReverse:function(){this.sort(!0)},moveTo:function(a){0>a||a>=this.rows.length||(this.currentIndex=a,j(this))},moveNext:function(){this.moveTo(this.currentIndex+1)},movePrevious:function(){this.moveTo(this.currentIndex-1)},moveToTop:function(){this.moveTo(0)},moveToBottom:function(){this.moveTo(this.rows.length-1)},findIndex:function(a){return _.findIndex(this.rows,function(b){return b.id==a})},"delete":function(a){if(!(this.rows.length<=0)){var b=this.getInstance(a).id,c=_.remove(this.rows,function(a){return a.id===b});c=_.remove(c,function(a){return"INSERTED"!==a.state}),c&&c.length>0&&(d(c[0]),this.deleted.push(c[0])),this.currentIndex>=this.rows.length&&(this.currentIndex=this.rows.length-1),j(this)}},getInstance:function(a){return a||(a=this.currentIndex),(!a||0>a)&&(a=0),this.rows&&0!==this.rows.length?this.rows[a]:null},reloadFromServer:function(a){b.debug("reloadFromServer"),b.debug(a),b.debug(this),_.forEach(this.rows,function(c){var d;switch(c.state){case"INSERTED":b.debug(c),d=_.find(a,function(a){return a.tempID===c.id}),d?(c.state="NO_CHANGE",c.data=d.data,c.id=d.id):(console.error("Failed to find matching inserted row"),console.error(c));break;case"UPDATED":b.debug(c),d=_.find(a,function(a){return a.id===c.id}),d?(c.state="NO_CHANGE",c.data=d.data):(console.error("Failed to find matching updated row"),console.error(c))}}),this.deleted.length=0}},h=_.defaults({},g);return h.model.modelName=c.name,h.model.orderBy=c.orderBy,h.parentInstance=f,h.insert=function(){var a=new k(c,{},h);return h.rows.push(a),h.moveToBottom(),d(a),a},angular.isArray(e)?(_.forEach(e,function(a){var b=new k(c,a,h);h.rows.push(b)}),h.rows.length&&(h.currentIndex=0)):(console.warn("SmartNodeSet expected data to be array but got the following:"),console.warn(e)),h},m={root:e,current:f,setRoot:function(a,b){h(),_.isEmpty(a)||(i(a),e=new l(a,b),m.root=e,j(e),m.current=f,m.dirty=!1)},getCurrentInstance:function(a){return f.instances[a]},getCurrentSet:function(a){if(void 0===f.sets[a]){var b=g[a].parent,c=f.instances[b];c.addChildModel({data:{modelName:a}},[]),j(m.root)}return f.sets[a]},dirty:!1,change:function(a){("NO_CHANGE"===a.state||"CHILD_UPDATED"===a.state)&&(a.state="UPDATED",d(a),m.dirty=!0)},action:{length:function(a){return a in f.sets?f.sets[a].rows.length:0},insert:function(a){var b=m.getCurrentSet(a).insert();return m.dirty=!0,b},"delete":function(a,b){f.sets[a]["delete"](b),m.dirty=!0},deleteEnabled:function(a){return null!=f.instances[a]},choose:function(a,b){var c=f.sets[a].findIndex(b);f.sets[a].moveTo(c)},select:function(a,b){f.sets[a].moveTo(b)},previous:function(a){f.sets[a].movePrevious()},next:function(a){f.sets[a].moveNext()}}};return m}]),angular.module("tantalim.common").factory("ModelSaver",["$http","$log",function(a,b){var c,d={convertToDto:function(a,c){var e=(a.name,function(a){return{state:a.state,tempID:a.id,data:a.data}}),f=function(a){return{state:a.state,id:a.id,data:a.data}},g=function(a){return{state:"DELETED",id:a.id}},h=function(a,b,c){var e=!1;a.children={},_.forEach(b.children,function(b){var f=b.name,g=d.convertToDto(b,c.childModels[f]);g.length>0&&(a.children[f]=g,e=!0)}),e||delete a.children},i=[];return c?(b.debug(c),_.forEach(c.rows,function(b){var c={};c="INSERTED"===b.state?e(b):"UPDATED"===b.state?f(b):"CHILD_UPDATED"===b.state?f(b):null,c&&(i.push(c),h(c,a,b))}),_.forEach(c.deleted,function(b){var c=g(b);i.push(c),h(c,a,b)}),i):(b.debug("dataSet is empty so exit"),i)},sendData:function(d,e,f){b.debug("sendData()..."),b.debug(e),a.post("/data/"+d,e).success(function(a,b){200===b?a.error?f("Failed to save data "+a.error):(c.reloadFromServer(a),f()):(f("Failed "+b),console.error(b),console.error(a))}).error(function(a,b){404===b&&f("Server not found. Check your Internet connection and try again."),console.error(b),console.error(a)})},save:function(a,e,f){c=e,b.debug("Starting ModelSaver.save");var g=d.convertToDto(a,c);d.sendData(a.name,g,f)}};return d}]),angular.module("tantalim.common").factory("PageService",function(a){return{readModelData:function(b,c,d){var e="/data/"+b+"?";return c&&(e+="filterString="+c),d&&(c&&(e+="&"),e+="pageNumber="+d),a.get(e)},getMenu:function(){return a.get("/menu/")}}});